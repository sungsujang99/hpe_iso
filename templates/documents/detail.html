{% extends "base.html" %}

{% block title %}문서 상세 - HPE System{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}문서 상세{% endblock %}

{% block breadcrumb %}
<a href="/">홈</a>
<span>›</span>
<a href="/documents/">문서 목록</a>
<span>›</span>
<span id="breadcrumb-docnum">문서</span>
{% endblock %}

{% block content %}
<div id="document-content">
    <div style="text-align: center; padding: 48px; color: var(--text-muted);">
        로딩 중...
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const documentId = window.location.pathname.split('/').filter(Boolean).pop();
    
    async function loadDocument() {
        console.log('Loading document:', documentId);
        try {
            const response = await apiRequest(`/documents/items/${documentId}/`);
            console.log('Document response:', response);
            
            if (!response) {
                document.getElementById('document-content').innerHTML = `
                    <div class="card" style="text-align: center; padding: 48px;">
                        <p style="color: var(--danger);">서버 응답이 없습니다.</p>
                        <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">목록으로</a>
                    </div>
                `;
                return;
            }
            
            if (response && response.ok) {
                const doc = await response.json();
                console.log('Document loaded:', doc);
                renderDocument(doc);
            } else {
                const errorText = await response.text();
                console.error('Error loading document:', response.status, errorText);
                document.getElementById('document-content').innerHTML = `
                    <div class="card" style="text-align: center; padding: 48px;">
                        <p style="color: var(--danger);">문서를 찾을 수 없습니다. (${response.status})</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">문서 ID: ${documentId}</p>
                        <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">목록으로</a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load document:', error);
            document.getElementById('document-content').innerHTML = `
                <div class="card" style="text-align: center; padding: 48px;">
                    <p style="color: var(--danger);">문서를 불러오는데 실패했습니다.</p>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">${error.message}</p>
                    <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">목록으로</a>
                </div>
            `;
        }
    }
    
    function renderDocument(doc) {
        currentDocument = doc;
        document.getElementById('breadcrumb-docnum').textContent = doc.document_number;
        
        const canEdit = doc.can_edit;
        const canSubmit = doc.can_submit;
        const canReview = doc.can_review;
        const canApprove = doc.can_approve;
        
        // 엑셀 파일이 있으면 다운로드 버튼 표시
        if (doc.excel_file) {
            setTimeout(() => {
                const excelBtn = document.getElementById('btn-download-excel');
                if (excelBtn) {
                    excelBtn.style.display = 'block';
                }
            }, 100);
        }
        
        document.getElementById('document-content').innerHTML = `
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                <!-- 문서 내용 -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${doc.title}</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 4px;">${doc.document_number}</p>
                        </div>
                        ${getStatusBadge(doc.status)}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div class="low-stock-item">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">카테고리</div>
                                <div style="font-weight: 600;">${doc.category_detail?.name || '-'}</div>
                            </div>
                        </div>
                        <div class="low-stock-item">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">개정번호</div>
                                <div style="font-weight: 600;">Rev.${doc.revision}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                        <h4 style="margin: 0;">문서 내용</h4>
                        ${canEdit ? '<span style="color: var(--text-muted); font-size: 0.8rem;">※ 문서번호와 제목은 수정할 수 없습니다</span>' : ''}
                    </div>
                    <div id="content-display">
                        ${renderContentData(doc.content_data)}
                    </div>
                    ${canEdit ? `
                        <div id="content-edit" style="display: none;">
                            ${renderContentEditForm(doc.content_data)}
                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="saveContent()">저장</button>
                                <button class="btn btn-secondary" onclick="cancelEdit()">취소</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${doc.comments?.length > 0 ? `
                        <h4 style="margin: 24px 0 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">코멘트</h4>
                        ${doc.comments.map(c => `
                            <div class="low-stock-item" style="flex-direction: column; align-items: flex-start;">
                                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 8px;">
                                    <strong>${c.user_name}</strong>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">${formatDateTime(c.created_at)}</span>
                                </div>
                                <p>${c.content}</p>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
                
                <!-- 사이드바 -->
                <div>
                    <!-- 작업 버튼 -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 16px;">작업</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${canEdit ? `
                                <button class="btn btn-secondary" style="width: 100%;" onclick="toggleEditMode()">
                                    내용 수정하기
                                </button>
                            ` : ''}
                            ${canSubmit ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="submitDocument()">
                                    승인 요청
                                </button>
                            ` : ''}
                            ${canReview ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="reviewDocument('approve')">
                                    검토 승인
                                </button>
                                <button class="btn btn-danger" style="width: 100%;" onclick="reviewDocument('reject')">
                                    검토 반려
                                </button>
                            ` : ''}
                            ${canApprove ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="approveDocument('approve')">
                                    최종 승인
                                </button>
                                <button class="btn btn-danger" style="width: 100%;" onclick="approveDocument('reject')">
                                    최종 반려
                                </button>
                            ` : ''}
                            <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="previewPDF()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                PDF 미리보기
                            </button>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="downloadPDF()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                PDF 다운로드
                            </button>
                            <button id="btn-download-excel" class="btn btn-success" style="width: 100%; display: none;" onclick="downloadExcel()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                엑셀 다운로드
                            </button>
                        </div>
                    </div>
                    
                    <!-- 문서 정보 -->
                    <div class="card">
                        <h4 style="margin-bottom: 16px;">문서 정보</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div class="low-stock-item">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">작성자</div>
                                <div style="font-weight: 500;">${doc.created_by_name || '-'}</div>
                            </div>
                            <div class="low-stock-item">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">작성일</div>
                                <div>${formatDateTime(doc.created_at)}</div>
                            </div>
                            ${doc.reviewed_by_name ? `
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">검토자</div>
                                    <div style="font-weight: 500;">${doc.reviewed_by_name}</div>
                                </div>
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">검토일</div>
                                    <div>${formatDateTime(doc.reviewed_at)}</div>
                                </div>
                            ` : ''}
                            ${doc.approved_by_name ? `
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">승인자</div>
                                    <div style="font-weight: 500;">${doc.approved_by_name}</div>
                                </div>
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">승인일</div>
                                    <div>${formatDateTime(doc.approved_at)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    let currentDocument = null;
    let editMode = false;
    
    function renderContentData(data) {
        if (!data || Object.keys(data).length === 0) {
            return '<p style="color: var(--text-muted);">내용이 없습니다.</p>';
        }
        
        const labels = {
            'occurrence_date': '발생 일시',
            'nonconformity_content': '부적합 내용',
            'cause_analysis': '원인 분석',
            'corrective_action': '시정 조치 계획',
            'preventive_action': '예방 조치',
            'target_date': '목표 완료일',
            'remarks': '비고'
        };
        
        return Object.entries(data).map(([key, value]) => {
            if (!value) return '';
            const label = labels[key] || key;
            let displayValue = value;
            if (key.includes('date')) {
                try {
                    const date = new Date(value);
                    displayValue = date.toLocaleString('ko-KR');
                } catch (e) {
                    displayValue = value;
                }
            }
            return `
                <div class="form-group">
                    <label class="form-label">${label}</label>
                    <div style="padding: 14px 18px; background: var(--primary); border-radius: 12px; white-space: pre-wrap;">${displayValue}</div>
                </div>
            `;
        }).join('');
    }
    
    function renderContentEditForm(data) {
        if (!data) data = {};
        
        const labels = {
            'occurrence_date': '발생 일시',
            'nonconformity_content': '부적합 내용',
            'cause_analysis': '원인 분석',
            'corrective_action': '시정 조치 계획',
            'preventive_action': '예방 조치',
            'target_date': '목표 완료일',
            'remarks': '비고'
        };
        
        return Object.keys(labels).map(key => {
            const label = labels[key];
            const value = data[key] || '';
            const isDate = key.includes('date');
            const isTextarea = key.includes('content') || key.includes('analysis') || key.includes('action') || key === 'remarks';
            
            if (isDate) {
                let dateValue = value;
                if (value && !value.includes('T')) {
                    try {
                        const date = new Date(value);
                        if (key === 'occurrence_date') {
                            dateValue = date.toISOString().slice(0, 16);
                        } else {
                            dateValue = date.toISOString().slice(0, 10);
                        }
                    } catch (e) {
                        dateValue = value;
                    }
                }
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <input type="${key === 'occurrence_date' ? 'datetime-local' : 'date'}" 
                               class="form-input" 
                               id="edit-${key}" 
                               value="${dateValue}">
                    </div>
                `;
            } else if (isTextarea) {
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <textarea class="form-input" id="edit-${key}" rows="4">${value}</textarea>
                    </div>
                `;
            } else {
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <input type="text" class="form-input" id="edit-${key}" value="${value}">
                    </div>
                `;
            }
        }).join('');
    }
    
    function toggleEditMode() {
        editMode = !editMode;
        document.getElementById('content-display').style.display = editMode ? 'none' : 'block';
        document.getElementById('content-edit').style.display = editMode ? 'block' : 'none';
    }
    
    function cancelEdit() {
        editMode = false;
        toggleEditMode();
    }
    
    async function saveContent() {
        const contentData = {};
        const fields = ['occurrence_date', 'nonconformity_content', 'cause_analysis', 
                       'corrective_action', 'preventive_action', 'target_date', 'remarks'];
        
        fields.forEach(field => {
            const el = document.getElementById(`edit-${field}`);
            if (el && el.value) {
                contentData[field] = el.value;
            }
        });
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/`, {
                method: 'PATCH',
                body: JSON.stringify({ content_data: contentData })
            });
            
            if (response && response.ok) {
                const updatedDoc = await response.json();
                currentDocument = updatedDoc;
                document.getElementById('content-display').innerHTML = renderContentData(updatedDoc.content_data);
                cancelEdit();
                alert('내용이 저장되었습니다.');
            } else {
                const error = await response.json();
                alert('저장 실패: ' + JSON.stringify(error));
            }
        } catch (error) {
            alert('오류 발생');
        }
    }
    
    function getStatusBadge(status) {
        const badges = {
            'draft': '<span class="badge badge-gray">작성중</span>',
            'pending_review': '<span class="badge badge-warning">검토 대기</span>',
            'pending_approval': '<span class="badge badge-info">승인 대기</span>',
            'approved': '<span class="badge badge-success">승인 완료</span>',
            'rejected': '<span class="badge badge-danger">반려</span>',
        };
        return badges[status] || `<span class="badge badge-gray">${status}</span>`;
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('ko-KR');
    }
    
    async function submitDocument() {
        if (!confirm('승인을 요청하시겠습니까?\n요청 후에는 수정할 수 없습니다.')) return;
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/submit/`, {
                method: 'POST',
                body: JSON.stringify({})
            });
            
            if (response && response.ok) {
                alert('승인이 요청되었습니다.');
                loadDocument();
            } else {
                alert('요청 실패');
            }
        } catch (error) {
            alert('오류 발생');
        }
    }
    
    async function reviewDocument(action) {
        const comment = action === 'reject' ? prompt('반려 사유를 입력하세요:') : '';
        if (action === 'reject' && !comment) {
            alert('반려 사유는 필수입니다.');
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/review/`, {
                method: 'POST',
                body: JSON.stringify({ action, comment })
            });
            
            if (response && response.ok) {
                alert(action === 'approve' ? '검토 승인되었습니다.' : '검토 반려되었습니다.');
                loadDocument();
            } else {
                alert('처리 실패');
            }
        } catch (error) {
            alert('오류 발생');
        }
    }
    
    async function approveDocument(action) {
        const comment = action === 'reject' ? prompt('반려 사유를 입력하세요:') : '';
        if (action === 'reject' && !comment) {
            alert('반려 사유는 필수입니다.');
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/approve/`, {
                method: 'POST',
                body: JSON.stringify({ action, comment })
            });
            
            if (response && response.ok) {
                alert(action === 'approve' ? '최종 승인되었습니다.' : '최종 반려되었습니다.');
                loadDocument();
            } else {
                alert('처리 실패');
            }
        } catch (error) {
            alert('오류 발생');
        }
    }
    
    async function previewPDF() {
        try {
            const response = await apiRequest(`/documents/items/${documentId}/download_pdf/`);
            if (response && response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // 새 탭에서 PDF 열기
                const newWindow = window.open(url, '_blank');
                
                if (!newWindow) {
                    alert('팝업 차단이 활성화되어 있습니다. 팝업을 허용해주세요.');
                    // 팝업이 차단된 경우 다운로드로 대체
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentDocument.document_number}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
                
                // URL은 새 탭이 닫힐 때 자동으로 정리됨
                // 하지만 메모리 관리를 위해 일정 시간 후 해제
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 60000); // 1분 후
            } else {
                alert('PDF 생성에 실패했습니다.');
            }
        } catch (error) {
            console.error('Failed to preview PDF:', error);
            alert('PDF 미리보기 중 오류가 발생했습니다.');
        }
    }
    
    async function downloadPDF() {
        try {
            const response = await apiRequest(`/documents/items/${documentId}/download_pdf/`);
            if (response && response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentDocument.document_number}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('PDF 생성에 실패했습니다.');
            }
        } catch (error) {
            console.error('Failed to download PDF:', error);
            alert('PDF 다운로드 중 오류가 발생했습니다.');
        }
    }
    
    async function downloadExcel() {
        if (!currentDocument || !currentDocument.excel_file) {
            alert('엑셀 파일이 없습니다.');
            return;
        }
        
        try {
            const a = document.createElement('a');
            a.href = currentDocument.excel_file;
            a.download = `${currentDocument.document_number}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('Failed to download Excel:', error);
            alert('엑셀 다운로드 중 오류가 발생했습니다.');
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadDocument);
</script>
{% endblock %}
