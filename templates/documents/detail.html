{% extends "base.html" %}

{% block title %}ë¬¸ì„œ ìƒì„¸ - HPE System{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ë¬¸ì„œ ìƒì„¸{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/documents/">ë¬¸ì„œ ëª©ë¡</a>
<span>â€º</span>
<span id="breadcrumb-docnum">ë¬¸ì„œ</span>
{% endblock %}

{% block content %}
<div id="document-content">
    <div style="text-align: center; padding: 48px; color: var(--text-muted);">
        ë¡œë”© ì¤‘...
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
#excel-readonly-container table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.85rem;
    background: white;
    color: #222;
}
#excel-readonly-container th {
    background: #f0f0f0;
    border: 1px solid #ccc;
    padding: 4px 8px;
    font-weight: 600;
    text-align: center;
    color: #333;
    position: sticky;
    top: 0;
    z-index: 2;
    font-size: 0.75rem;
}
#excel-readonly-container td {
    border: 1px solid #ddd;
    padding: 4px 8px;
    min-width: 60px;
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #222;
}
#excel-readonly-container .row-header {
    background: #f8f8f8;
    text-align: center;
    font-weight: 600;
    color: #666;
    min-width: 40px;
    max-width: 40px;
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/xlsx.full.min.js"></script>
<script>
    const documentId = window.location.pathname.split('/').filter(Boolean).pop();
    
    async function loadDocument() {
        console.log('Loading document:', documentId);
        try {
            const response = await apiRequest(`/documents/items/${documentId}/`);
            console.log('Document response:', response);
            
            if (!response) {
                document.getElementById('document-content').innerHTML = `
                    <div class="card" style="text-align: center; padding: 48px;">
                        <p style="color: var(--danger);">ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">ëª©ë¡ìœ¼ë¡œ</a>
                    </div>
                `;
                return;
            }
            
            if (response && response.ok) {
                const doc = await response.json();
                console.log('Document loaded:', doc);
                renderDocument(doc);
            } else {
                const errorText = await response.text();
                console.error('Error loading document:', response.status, errorText);
                document.getElementById('document-content').innerHTML = `
                    <div class="card" style="text-align: center; padding: 48px;">
                        <p style="color: var(--danger);">ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${response.status})</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">ë¬¸ì„œ ID: ${documentId}</p>
                        <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">ëª©ë¡ìœ¼ë¡œ</a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load document:', error);
            document.getElementById('document-content').innerHTML = `
                <div class="card" style="text-align: center; padding: 48px;">
                    <p style="color: var(--danger);">ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">${error.message}</p>
                    <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">ëª©ë¡ìœ¼ë¡œ</a>
                </div>
            `;
        }
    }
    
    function renderDocument(doc) {
        currentDocument = doc;
        document.getElementById('breadcrumb-docnum').textContent = doc.title ? `${doc.title} (${doc.document_number})` : doc.document_number;
        
        const canEdit = doc.can_edit;
        const canSubmit = doc.can_submit;
        const canReview = doc.can_review;
        const canApprove = doc.can_approve;
        
        document.getElementById('document-content').innerHTML = `
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                <!-- ë¬¸ì„œ ë‚´ìš© -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${doc.title} (${doc.document_number})</h3>
                        </div>
                        ${getStatusBadge(doc.status)}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div class="low-stock-item">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">ì¹´í…Œê³ ë¦¬</div>
                                <div style="font-weight: 600;">${doc.category_detail?.name || '-'}</div>
                            </div>
                        </div>
                        <div class="low-stock-item">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">ê°œì •ë²ˆí˜¸</div>
                                <div style="font-weight: 600;">Rev.${doc.revision}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                        <h4 style="margin: 0;">ë¬¸ì„œ ë‚´ìš©</h4>
                        ${doc.excel_file ? '<span style="color: var(--text-muted); font-size: 0.8rem;">ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° (ì½ê¸° ì „ìš©)</span>' : 
                          (canEdit ? '<span style="color: var(--text-muted); font-size: 0.8rem;">â€» ë¬¸ì„œë²ˆí˜¸ì™€ ì œëª©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>' : '')}
                    </div>
                    <div id="excel-readonly-container" style="display: none; overflow: auto; max-height: 600px; border: 1px solid #ddd; border-radius: 8px; background: white;"></div>
                    <div id="content-display">
                        ${renderContentData(doc.content_data)}
                    </div>
                    ${canEdit ? '<div id="content-edit" style="display: none;"></div>' : ''}
                    
                    ${doc.comments?.length > 0 ? `
                        <h4 style="margin: 24px 0 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">ì½”ë©˜íŠ¸</h4>
                        ${doc.comments.map(c => `
                            <div class="low-stock-item" style="flex-direction: column; align-items: flex-start;">
                                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 8px;">
                                    <strong>${c.user_name}</strong>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">${formatDateTime(c.created_at)}</span>
                                </div>
                                <p>${c.content}</p>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
                
                <!-- ì‚¬ì´ë“œë°” -->
                <div>
                    <!-- ì‘ì—… ë²„íŠ¼ -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 16px;">ì‘ì—…</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${canEdit ? `
                                <button class="btn btn-secondary" style="width: 100%;" onclick="toggleEditMode()">
                                    ë‚´ìš© ìˆ˜ì •í•˜ê¸°
                                </button>
                            ` : ''}
                            ${canSubmit ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="submitDocument()">
                                    ìŠ¹ì¸ ìš”ì²­
                                </button>
                            ` : ''}
                            ${canReview ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="reviewDocument('approve')">
                                    ê²€í†  ìŠ¹ì¸
                                </button>
                                <button class="btn btn-danger" style="width: 100%;" onclick="reviewDocument('reject')">
                                    ê²€í†  ë°˜ë ¤
                                </button>
                            ` : ''}
                            ${canApprove ? `
                                <button class="btn btn-success" style="width: 100%;" onclick="approveDocument('approve')">
                                    ìµœì¢… ìŠ¹ì¸
                                </button>
                                <button class="btn btn-danger" style="width: 100%;" onclick="approveDocument('reject')">
                                    ìµœì¢… ë°˜ë ¤
                                </button>
                            ` : ''}
                            ${doc.status === 'approved' ? `
                                <button class="btn btn-primary" style="width: 100%;" onclick="downloadPDF()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    PDF ë‹¤ìš´ë¡œë“œ
                                </button>
                                ${doc.excel_file ? `
                                    <button class="btn btn-success" style="width: 100%;" onclick="downloadExcel()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                    </button>
                                ` : ''}
                            ` : `
                                <div style="padding: 12px; background: var(--primary); border: 1px solid var(--border); border-radius: 8px; text-align: center;">
                                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                                        ğŸ“„ ìŠ¹ì¸ ì™„ë£Œ í›„ PDF ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- ë¬¸ì„œ ì •ë³´ -->
                    <div class="card">
                        <h4 style="margin-bottom: 16px;">ë¬¸ì„œ ì •ë³´</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div class="low-stock-item">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">ì‘ì„±ì</div>
                                <div style="font-weight: 500;">${doc.created_by_name || '-'}</div>
                            </div>
                            <div class="low-stock-item">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">ì‘ì„±ì¼</div>
                                <div>${formatDateTime(doc.created_at)}</div>
                            </div>
                            ${doc.reviewed_by_name ? `
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">ê²€í† ì</div>
                                    <div style="font-weight: 500;">${doc.reviewed_by_name}</div>
                                </div>
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">ê²€í† ì¼</div>
                                    <div>${formatDateTime(doc.reviewed_at)}</div>
                                </div>
                            ` : ''}
                            ${doc.approved_by_name ? `
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">ìŠ¹ì¸ì</div>
                                    <div style="font-weight: 500;">${doc.approved_by_name}</div>
                                </div>
                                <div class="low-stock-item">
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">ìŠ¹ì¸ì¼</div>
                                    <div>${formatDateTime(doc.approved_at)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° ë“± í›„ì²˜ë¦¬
        setTimeout(() => postRenderDocument(doc), 100);
    }
    
    let currentDocument = null;
    let editMode = false;
    
    // ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° í›„ì²˜ë¦¬
    function postRenderDocument(doc) {
        // ì—‘ì…€ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
        if (doc.excel_file) {
            document.getElementById('content-display').style.display = 'none';
            const container = document.getElementById('excel-readonly-container');
            container.style.display = 'block';
            container.innerHTML = '<div style="text-align: center; padding: 24px; color: #666;">ì—‘ì…€ ë¡œë”© ì¤‘...</div>';
            loadExcelReadonly(doc.excel_file, container);
        }
        
        // í¸ì§‘ ê°€ëŠ¥í•˜ë©´ í¸ì§‘ í¼ ì„¸íŒ…
        if (doc.can_edit && !doc.excel_file) {
            const editDiv = document.getElementById('content-edit');
            if (editDiv) {
                editDiv.innerHTML = renderContentEditForm(doc.content_data) + 
                    '<div style="display: flex; gap: 12px; margin-top: 20px;">' +
                    '<button class="btn btn-primary" onclick="saveContent()">ì €ì¥</button>' +
                    '<button class="btn btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button></div>';
            }
        }
    }
    
    // SheetJS ìƒ‰ìƒì„ CSS ìƒ‰ìƒìœ¼ë¡œ ë³€í™˜
    function xlsxColorToCSS(color) {
        if (!color) return null;
        if (color.rgb) {
            const rgb = color.rgb.length === 8 ? color.rgb.substring(2) : color.rgb;
            return '#' + rgb;
        }
        if (color.theme !== undefined) {
            const themeColors = ['#000000','#FFFFFF','#44546A','#4472C4','#ED7D31','#A5A5A5','#FFC000','#5B9BD5','#70AD47','#264478','#9B57A0','#636363'];
            let base = themeColors[color.theme] || '#000000';
            if (color.tint) base = applyTint(base, color.tint);
            return base;
        }
        if (color.indexed !== undefined) {
            const ic = ['#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF','#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF','#800000','#008000','#000080','#808000','#800080','#008080','#C0C0C0','#808080','#9999FF','#993366','#FFFFCC','#CCFFFF','#660066','#FF8080','#0066CC','#CCCCFF','#000080','#FF00FF','#FFFF00','#00FFFF','#800080','#800000','#008080','#0000FF','#00CCFF','#CCFFFF','#CCFFCC','#FFFF99','#99CCFF','#FF99CC','#CC99FF','#FFCC99','#3366FF','#33CCCC','#99CC00','#FFCC00','#FF9900','#FF6600','#666699','#969696','#003366','#339966','#003300','#333300','#993300','#993366','#333399','#333333'];
            return ic[color.indexed] || null;
        }
        return null;
    }
    function applyTint(hex, tint) {
        let r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
        if (tint > 0) { r = Math.round(r+(255-r)*tint); g = Math.round(g+(255-g)*tint); b = Math.round(b+(255-b)*tint); }
        else { r = Math.round(r*(1+tint)); g = Math.round(g*(1+tint)); b = Math.round(b*(1+tint)); }
        return '#' + [r,g,b].map(x => Math.min(255,Math.max(0,x)).toString(16).padStart(2,'0')).join('');
    }
    function getCellStyle(cell) {
        if (!cell || !cell.s) return '';
        const s = cell.s; let styles = [];
        if (s.fgColor) { const bg = xlsxColorToCSS(s.fgColor); if (bg && bg !== '#000000') styles.push('background-color:'+bg); }
        if (s.bgColor && !styles.length) { const bg = xlsxColorToCSS(s.bgColor); if (bg && bg !== '#000000') styles.push('background-color:'+bg); }
        if (s.patternType === 'solid' && s.fgColor) { const bg = xlsxColorToCSS(s.fgColor); if (bg) { styles = styles.filter(st => !st.startsWith('background-color')); styles.push('background-color:'+bg); } }
        if (s.color) { const fc = xlsxColorToCSS(s.color); if (fc) styles.push('color:'+fc); }
        if (s.bold) styles.push('font-weight:bold');
        if (s.italic) styles.push('font-style:italic');
        if (s.underline) styles.push('text-decoration:underline');
        if (s.sz) styles.push('font-size:'+Math.max(s.sz*0.75,9)+'px');
        if (s.alignment) {
            if (s.alignment.horizontal) { const m={center:'center',right:'right',left:'left',justify:'justify'}; if(m[s.alignment.horizontal]) styles.push('text-align:'+m[s.alignment.horizontal]); }
            if (s.alignment.vertical) { const m={center:'middle',top:'top',bottom:'bottom'}; if(m[s.alignment.vertical]) styles.push('vertical-align:'+m[s.alignment.vertical]); }
            if (s.alignment.wrapText) styles.push('white-space:pre-wrap');
        }
        if (s.top||s.bottom||s.left||s.right) {
            const bs = b => { if(!b||!b.style) return ''; const c=b.color?xlsxColorToCSS(b.color)||'#000':'#000'; const w=b.style==='thin'?'1px':b.style==='medium'?'2px':'1px'; return w+' solid '+c; };
            if(s.top){const v=bs(s.top);if(v)styles.push('border-top:'+v);}
            if(s.bottom){const v=bs(s.bottom);if(v)styles.push('border-bottom:'+v);}
            if(s.left){const v=bs(s.left);if(v)styles.push('border-left:'+v);}
            if(s.right){const v=bs(s.right);if(v)styles.push('border-right:'+v);}
        }
        return styles.join(';');
    }

    async function loadExcelReadonly(fileUrl, container) {
        try {
            const response = await fetch(fileUrl);
            if (!response.ok) throw new Error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array', cellStyles: true, cellNF: true });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
            const merges = sheet['!merges'] || [];
            const cols = sheet['!cols'] || [];
            const rows = sheet['!rows'] || [];
            
            // ë³‘í•© ë§µ
            const mergeMap = {};
            merges.forEach(m => {
                for (let r = m.s.r; r <= m.e.r; r++) {
                    for (let c = m.s.c; c <= m.e.c; c++) {
                        if (r === m.s.r && c === m.s.c) {
                            mergeMap[r + '_' + c] = { rowspan: m.e.r - m.s.r + 1, colspan: m.e.c - m.s.c + 1, isOrigin: true };
                        } else {
                            mergeMap[r + '_' + c] = { skip: true };
                        }
                    }
                }
            });
            
            let html = '<table>';
            html += '<tr><th style="min-width:40px;"></th>';
            for (let c = range.s.c; c <= range.e.c; c++) {
                const colInfo = cols[c];
                const w = colInfo && colInfo.wpx ? colInfo.wpx + 'px' : colInfo && colInfo.wch ? (colInfo.wch * 7) + 'px' : 'auto';
                html += '<th style="width:' + w + '">' + XLSX.utils.encode_col(c) + '</th>';
            }
            html += '</tr>';
            
            for (let r = range.s.r; r <= range.e.r; r++) {
                const rowInfo = rows[r];
                const rh = rowInfo && rowInfo.hpx ? 'height:' + rowInfo.hpx + 'px;' : '';
                html += '<tr style="' + rh + '"><td class="row-header">' + (r + 1) + '</td>';
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const key = r + '_' + c;
                    const merge = mergeMap[key];
                    if (merge && merge.skip) continue;
                    
                    const addr = XLSX.utils.encode_cell({ r, c });
                    const cell = sheet[addr];
                    const value = cell ? (cell.w || String(cell.v || '')) : '';
                    const cellStyle = getCellStyle(cell);
                    
                    let attrs = cellStyle ? ' style="' + cellStyle + '"' : '';
                    if (merge && merge.isOrigin) {
                        if (merge.rowspan > 1) attrs += ' rowspan="' + merge.rowspan + '"';
                        if (merge.colspan > 1) attrs += ' colspan="' + merge.colspan + '"';
                    }
                    
                    html += '<td' + attrs + '>' + value + '</td>';
                }
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Excel load error:', error);
            container.innerHTML = '<div style="text-align: center; padding: 24px; color: #d93025;">ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    function renderContentData(data) {
        if (!data || Object.keys(data).length === 0) {
            return '<p style="color: var(--text-muted);">ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        
        const labels = {
            'occurrence_date': 'ë°œìƒ ì¼ì‹œ',
            'nonconformity_content': 'ë¶€ì í•© ë‚´ìš©',
            'cause_analysis': 'ì›ì¸ ë¶„ì„',
            'corrective_action': 'ì‹œì • ì¡°ì¹˜ ê³„íš',
            'preventive_action': 'ì˜ˆë°© ì¡°ì¹˜',
            'target_date': 'ëª©í‘œ ì™„ë£Œì¼',
            'remarks': 'ë¹„ê³ '
        };
        
        return Object.entries(data).map(([key, value]) => {
            if (!value) return '';
            const label = labels[key] || key;
            let displayValue = value;
            if (key.includes('date')) {
                try {
                    const date = new Date(value);
                    displayValue = date.toLocaleString('ko-KR');
                } catch (e) {
                    displayValue = value;
                }
            }
            return `
                <div class="form-group">
                    <label class="form-label">${label}</label>
                    <div style="padding: 14px 18px; background: var(--primary); border-radius: 12px; white-space: pre-wrap;">${displayValue}</div>
                </div>
            `;
        }).join('');
    }
    
    function renderContentEditForm(data) {
        if (!data) data = {};
        
        const labels = {
            'occurrence_date': 'ë°œìƒ ì¼ì‹œ',
            'nonconformity_content': 'ë¶€ì í•© ë‚´ìš©',
            'cause_analysis': 'ì›ì¸ ë¶„ì„',
            'corrective_action': 'ì‹œì • ì¡°ì¹˜ ê³„íš',
            'preventive_action': 'ì˜ˆë°© ì¡°ì¹˜',
            'target_date': 'ëª©í‘œ ì™„ë£Œì¼',
            'remarks': 'ë¹„ê³ '
        };
        
        return Object.keys(labels).map(key => {
            const label = labels[key];
            const value = data[key] || '';
            const isDate = key.includes('date');
            const isTextarea = key.includes('content') || key.includes('analysis') || key.includes('action') || key === 'remarks';
            
            if (isDate) {
                let dateValue = value;
                if (value && !value.includes('T')) {
                    try {
                        const date = new Date(value);
                        if (key === 'occurrence_date') {
                            dateValue = date.toISOString().slice(0, 16);
                        } else {
                            dateValue = date.toISOString().slice(0, 10);
                        }
                    } catch (e) {
                        dateValue = value;
                    }
                }
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <input type="${key === 'occurrence_date' ? 'datetime-local' : 'date'}" 
                               class="form-input" 
                               id="edit-${key}" 
                               value="${dateValue}">
                    </div>
                `;
            } else if (isTextarea) {
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <textarea class="form-input" id="edit-${key}" rows="4">${value}</textarea>
                    </div>
                `;
            } else {
                return `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <input type="text" class="form-input" id="edit-${key}" value="${value}">
                    </div>
                `;
            }
        }).join('');
    }
    
    function toggleEditMode() {
        editMode = !editMode;
        document.getElementById('content-display').style.display = editMode ? 'none' : 'block';
        document.getElementById('content-edit').style.display = editMode ? 'block' : 'none';
    }
    
    function cancelEdit() {
        editMode = false;
        toggleEditMode();
    }
    
    async function saveContent() {
        const contentData = {};
        const fields = ['occurrence_date', 'nonconformity_content', 'cause_analysis', 
                       'corrective_action', 'preventive_action', 'target_date', 'remarks'];
        
        fields.forEach(field => {
            const el = document.getElementById(`edit-${field}`);
            if (el && el.value) {
                contentData[field] = el.value;
            }
        });
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/`, {
                method: 'PATCH',
                body: JSON.stringify({ content_data: contentData })
            });
            
            if (response && response.ok) {
                const updatedDoc = await response.json();
                currentDocument = updatedDoc;
                document.getElementById('content-display').innerHTML = renderContentData(updatedDoc.content_data);
                cancelEdit();
                alert('ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                const error = await response.json();
                alert('ì €ì¥ ì‹¤íŒ¨: ' + JSON.stringify(error));
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    function getStatusBadge(status) {
        const badges = {
            'draft': '<span class="badge badge-gray">ì‘ì„±ì¤‘</span>',
            'pending_review': '<span class="badge badge-warning">ê²€í†  ëŒ€ê¸°</span>',
            'pending_approval': '<span class="badge badge-info">ìŠ¹ì¸ ëŒ€ê¸°</span>',
            'approved': '<span class="badge badge-success">ìŠ¹ì¸ ì™„ë£Œ</span>',
            'rejected': '<span class="badge badge-danger">ë°˜ë ¤</span>',
        };
        return badges[status] || `<span class="badge badge-gray">${status}</span>`;
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('ko-KR');
    }
    
    async function submitDocument() {
        if (!confirm('ìŠ¹ì¸ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìš”ì²­ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/submit/`, {
                method: 'POST',
                body: JSON.stringify({})
            });
            
            if (response && response.ok) {
                alert('ìŠ¹ì¸ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocument();
            } else {
                alert('ìš”ì²­ ì‹¤íŒ¨');
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    async function reviewDocument(action) {
        const comment = action === 'reject' ? prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:') : '';
        if (action === 'reject' && !comment) {
            alert('ë°˜ë ¤ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/review/`, {
                method: 'POST',
                body: JSON.stringify({ action, comment })
            });
            
            if (response && response.ok) {
                alert(action === 'approve' ? 'ê²€í†  ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²€í†  ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocument();
            } else {
                alert('ì²˜ë¦¬ ì‹¤íŒ¨');
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    async function approveDocument(action) {
        const comment = action === 'reject' ? prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:') : '';
        if (action === 'reject' && !comment) {
            alert('ë°˜ë ¤ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/approve/`, {
                method: 'POST',
                body: JSON.stringify({ action, comment })
            });
            
            if (response && response.ok) {
                alert(action === 'approve' ? 'ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìµœì¢… ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocument();
            } else {
                alert('ì²˜ë¦¬ ì‹¤íŒ¨');
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    async function downloadPDF() {
        try {
            const response = await apiRequest(`/documents/items/${documentId}/download_pdf/`);
            if (response && response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentDocument.document_number}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Failed to download PDF:', error);
            alert('PDF ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    async function downloadExcel() {
        if (!currentDocument || !currentDocument.excel_file) {
            alert('ì—‘ì…€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const a = document.createElement('a');
            a.href = currentDocument.excel_file;
            a.download = `${currentDocument.document_number}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('Failed to download Excel:', error);
            alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadDocument);
</script>
{% endblock %}
