{% extends "base.html" %}

{% block title %}ë¬¸ì„œ ëª©ë¡ - HPE System{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ë¬¸ì„œ ëª©ë¡{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<span>ë¬¸ì„œ ëª©ë¡</span>
{% endblock %}

{% block content %}
<!-- Header Actions -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div style="display: flex; gap: 12px; flex: 1;">
        <select class="form-select" id="filter-status" style="width: 160px; padding: 12px 16px; border-radius: 12px;">
            <option value="">ì „ì²´ ìƒíƒœ</option>
            <option value="draft">ì‘ì„±ì¤‘</option>
            <option value="pending_review">ê²€í†  ëŒ€ê¸°</option>
            <option value="pending_approval">ìŠ¹ì¸ ëŒ€ê¸°</option>
            <option value="approved">ìŠ¹ì¸ ì™„ë£Œ</option>
            <option value="rejected">ë°˜ë ¤</option>
        </select>
        <select class="form-select" id="filter-category" style="width: 180px; padding: 12px 16px; border-radius: 12px;">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
        </select>
        <div style="position: relative; flex: 1; max-width: 400px;">
            <input type="text" class="form-input" id="search-input" placeholder="ë¬¸ì„œë²ˆí˜¸(ì˜ˆ: HP-QP-1010) ë˜ëŠ” ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 100%; padding: 12px 16px 12px 44px; border-radius: 12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--text-muted); pointer-events: none;">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>
    </div>
    <a href="/documents/new/" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        ìƒˆ ë¬¸ì„œ ì‘ì„±
    </a>
</div>

<!-- Documents Table -->
<div class="card">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ë¬¸ì„œë²ˆí˜¸</th>
                    <th>ì œëª©</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th>ìƒíƒœ</th>
                    <th>ì‘ì„±ì</th>
                    <th>ì‘ì„±ì¼</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="documents-table">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                        ë¡œë”© ì¤‘...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allDocuments = [];
    let categories = [];
    
    async function loadCategories() {
        try {
            const response = await apiRequest('/documents/categories/');
            if (response && response.ok) {
                categories = await response.json();
                const select = document.getElementById('filter-category');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = `${cat.code} - ${cat.name}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load categories:', error);
        }
    }
    
    async function loadDocuments() {
        try {
            const status = document.getElementById('filter-status').value;
            const category = document.getElementById('filter-category').value;
            const search = document.getElementById('search-input').value.trim();
            
            // 1. ì¼ë°˜ ë¬¸ì„œ ë¡œë“œ
            let url = '/documents/items/?';
            const params = [];
            if (status) params.push(`status=${status}`);
            if (category) params.push(`category=${category}`);
            if (search) params.push(`search=${encodeURIComponent(search)}`);
            
            url += params.join('&');
            
            const response = await apiRequest(url);
            let regularDocs = [];
            if (response && response.ok) {
                const data = await response.json();
                regularDocs = data.results || data;
            }
            
            // 2. ì—‘ì…€ ë¬¸ì„œ ë¡œë“œ
            const excelResponse = await apiRequest('/inventory/excel-documents/');
            let excelDocs = [];
            if (excelResponse && excelResponse.ok) {
                const excelData = await excelResponse.json();
                console.log('Excel documents loaded:', excelData);
                excelDocs = (excelData.results || excelData).map(doc => ({
                    ...doc,
                    is_excel: true,
                    document_number: doc.doc_type,
                    status: 'approved',  // ì—‘ì…€ ë¬¸ì„œëŠ” í•­ìƒ ìŠ¹ì¸ ìƒíƒœ
                    category_code: 'ì—‘ì…€',
                    created_by_name: '-',
                    created_at: doc.created_at
                }));
            }
            
            console.log('Regular docs:', regularDocs.length, 'Excel docs:', excelDocs.length);
            
            // 3. ë‘ ë¬¸ì„œë¥¼ í•©ì¹˜ê³  ì •ë ¬ (ìµœì‹ ìˆœ)
            allDocuments = [...regularDocs, ...excelDocs].sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            console.log('Total documents:', allDocuments.length);
            
            // í•„í„°ë§ ì ìš© (ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì—‘ì…€ ë¬¸ì„œë„ í•„í„°ë§)
            if (search) {
                allDocuments = allDocuments.filter(doc => {
                    const searchLower = search.toLowerCase();
                    return (doc.title && doc.title.toLowerCase().includes(searchLower)) ||
                           (doc.document_number && doc.document_number.toLowerCase().includes(searchLower));
                });
            }
            
            renderDocuments(allDocuments);
        } catch (error) {
            console.error('Failed to load documents:', error);
            document.getElementById('documents-table').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                        ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderDocuments(documents) {
        const tbody = document.getElementById('documents-table');
        
        if (documents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <p>ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="/documents/new/" class="btn btn-primary btn-sm" style="margin-top: 16px;">ìƒˆ ë¬¸ì„œ ì‘ì„±</a>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = documents.map(doc => {
            if (doc.is_excel) {
                // ì—‘ì…€ ë¬¸ì„œ
                return `
                    <tr>
                        <td>
                            <span style="color: var(--accent); font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                ğŸ“Š ${doc.doc_type_display}
                            </span>
                        </td>
                        <td>
                            <strong>${doc.title}</strong>
                            <br>
                            <small style="color: var(--text-muted);">${doc.total_items || 0}ê°œ í•­ëª©</small>
                        </td>
                        <td><span class="badge" style="background-color: #f0f0f0; color: #666;">ì—‘ì…€ ë¬¸ì„œ</span></td>
                        <td><span class="badge badge-success">ìŠ¹ì¸ ì™„ë£Œ</span></td>
                        <td>-</td>
                        <td>${formatDate(doc.created_at)}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <a href="/inventory/excel-documents/${doc.id}/view/" target="_blank" class="btn btn-primary btn-sm">
                                    ğŸ“„ ë³´ê¸°
                                </a>
                                <button class="btn btn-secondary btn-sm" onclick="downloadExcelFile('${doc.file_path}', '${doc.file_name}')">
                                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                // ì¼ë°˜ ë¬¸ì„œ
                return `
                    <tr>
                        <td>
                            <a href="/documents/${doc.id}/" style="color: var(--accent); text-decoration: none; font-weight: 600;">
                                ${doc.document_number}
                            </a>
                        </td>
                        <td>${doc.title}</td>
                        <td><span class="badge badge-info">${doc.category_code || '-'}</span></td>
                        <td>${getStatusBadge(doc.status)}</td>
                        <td>${doc.created_by_name || '-'}</td>
                        <td>${formatDate(doc.created_at)}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <a href="/documents/${doc.id}/" class="btn btn-secondary btn-sm">
                                    ìƒì„¸
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }).join('');
    }
    
    // ì—‘ì…€ ë¬¸ì„œ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
    async function showExcelDocumentDetail(docId) {
        console.log('Loading excel document:', docId);
        try {
            const response = await apiRequest(`/inventory/excel-documents/${docId}/items/`);
            console.log('Response:', response);
            
            if (!response) {
                alert('ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (response && response.ok) {
                const data = await response.json();
                console.log('Excel document data:', data);
                const doc = data.document;
                const items = data.items || [];
                
                // ì•ˆì „í•œ ê°’ ë Œë”ë§ í•¨ìˆ˜
                const safeValue = (val) => {
                    if (val === null || val === undefined) return '-';
                    if (typeof val === 'string' && val.startsWith('=')) return '-';
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string' && !isNaN(parseFloat(val))) return parseFloat(val);
                    return val;
                };
                
                // ëª¨ë‹¬ HTML ìƒì„±
                const modalHtml = `
                    <div id="excelModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: 1200px;">
                            <div class="modal-header" style="padding: 24px; border-bottom: 2px solid var(--border);">
                                <div>
                                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">ğŸ“Š ${doc.title}</h2>
                                    <p style="color: var(--text-muted); font-size: 0.9rem;">${doc.doc_type_display} â€¢ ì´ ${items.length}ê°œ í•­ëª©</p>
                                </div>
                                <button class="close-btn" onclick="closeExcelModal()" style="font-size: 2rem;">&times;</button>
                            </div>
                            <div class="modal-body" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
                                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                                    <input type="text" id="excelSearchInput" placeholder="ğŸ” ë°”ì½”ë“œ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." 
                                           onkeyup="searchExcelItems()" 
                                           style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem; white-space: nowrap;">
                                        <span id="filteredCount">${items.length}</span> / ${items.length}ê°œ
                                    </span>
                                </div>
                                <div class="table-wrapper" style="overflow: auto; border-radius: 10px; border: 1px solid var(--border);">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                                <th style="padding: 14px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">ë²ˆí˜¸</th>
                                                <th style="padding: 14px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">ë°”ì½”ë“œ</th>
                                                <th style="padding: 14px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">ì´ë¦„</th>
                                                ${items.some(i => i.received !== undefined) ? '<th style="padding: 14px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10;">ì…ê³ </th>' : ''}
                                                ${items.some(i => i.issued !== undefined) ? '<th style="padding: 14px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10;">ì¶œê³ </th>' : ''}
                                                ${items.some(i => i.current !== undefined) ? '<th style="padding: 14px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10;">í˜„ì¬</th>' : ''}
                                            </tr>
                                        </thead>
                                        <tbody id="excelItemsTable">
                                            ${items.map((item, idx) => `
                                                <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                                    <td style="padding: 12px; color: var(--text-muted);">${idx + 1}</td>
                                                    <td style="padding: 12px;"><code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px; font-size: 13px;">${item.barcode || '-'}</code></td>
                                                    <td style="padding: 12px; font-weight: 500;">${item.name || '-'}</td>
                                                    ${item.received !== undefined ? `<td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${safeValue(item.received)}</td>` : ''}
                                                    ${item.issued !== undefined ? `<td style="padding: 12px; text-align: center; color: #ef4444; font-weight: 600;">${safeValue(item.issued)}</td>` : ''}
                                                    ${item.current !== undefined ? `<td style="padding: 12px; text-align: center;"><strong style="font-size: 1.1rem; color: ${item.current > 0 ? '#3b82f6' : '#ef4444'};">${safeValue(item.current)}</strong></td>` : ''}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                const existingModal = document.getElementById('excelModal');
                if (existingModal) existingModal.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // ì „ì—­ ë³€ìˆ˜ë¡œ í•­ëª© ì €ì¥
                window.currentExcelItems = items;
            } else {
                // ì‘ë‹µì´ okê°€ ì•„ë‹ ë•Œ
                const errorText = await response.text();
                console.error('Error response:', response.status, errorText);
                alert(`ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status})`);
            }
        } catch (error) {
            console.error('Failed to load excel document:', error);
            alert('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
    
    function closeExcelModal() {
        const modal = document.getElementById('excelModal');
        if (modal) modal.remove();
    }
    
    function searchExcelItems() {
        if (!window.currentExcelItems) {
            console.error('currentExcelItems not defined');
            return;
        }
        
        const searchTerm = document.getElementById('excelSearchInput').value.toLowerCase();
        const filteredItems = window.currentExcelItems.filter(item => {
            return (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
                   (item.name && item.name.toLowerCase().includes(searchTerm));
        });
        
        const tbody = document.getElementById('excelItemsTable');
        const countSpan = document.getElementById('filteredCount');
        
        if (!tbody) {
            console.error('excelItemsTable not found');
            return;
        }
        
        // í•„í„°ë§ëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        if (countSpan) {
            countSpan.textContent = filteredItems.length;
        }
        
        const hasInventory = filteredItems.some(i => i.received !== undefined);
        
        // ì•ˆì „í•œ ê°’ ë Œë”ë§
        const safeValue = (val) => {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'string' && val.startsWith('=')) return '-';
            if (typeof val === 'number') return val;
            if (typeof val === 'string' && !isNaN(parseFloat(val))) return parseFloat(val);
            return val;
        };
        
        if (filteredItems.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
                        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = filteredItems.map((item, idx) => `
            <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                <td style="padding: 12px; color: var(--text-muted);">${idx + 1}</td>
                <td style="padding: 12px;"><code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px; font-size: 13px;">${item.barcode || '-'}</code></td>
                <td style="padding: 12px; font-weight: 500;">${item.name || '-'}</td>
                ${hasInventory ? `<td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${safeValue(item.received)}</td>` : ''}
                ${hasInventory ? `<td style="padding: 12px; text-align: center; color: #ef4444; font-weight: 600;">${safeValue(item.issued)}</td>` : ''}
                ${hasInventory ? `<td style="padding: 12px; text-align: center;"><strong style="font-size: 1.1rem; color: ${item.current > 0 ? '#3b82f6' : '#ef4444'};">${safeValue(item.current)}</strong></td>` : ''}
            </tr>
        `).join('');
    }
    
    function getStatusBadge(status) {
        const badges = {
            'draft': '<span class="badge badge-gray">ì‘ì„±ì¤‘</span>',
            'pending_review': '<span class="badge badge-warning">ê²€í†  ëŒ€ê¸°</span>',
            'pending_approval': '<span class="badge badge-info">ìŠ¹ì¸ ëŒ€ê¸°</span>',
            'approved': '<span class="badge badge-success">ìŠ¹ì¸ ì™„ë£Œ</span>',
            'rejected': '<span class="badge badge-danger">ë°˜ë ¤</span>',
        };
        return badges[status] || `<span class="badge badge-gray">${status}</span>`;
    }
    
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }
    
    // ê²€ìƒ‰ ì…ë ¥ ì‹œ ë””ë°”ìš´ìŠ¤ ì ìš©
    let searchTimeout;
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadDocuments();
        }, 300);
    }
    
    document.getElementById('filter-status').addEventListener('change', loadDocuments);
    document.getElementById('filter-category').addEventListener('change', loadDocuments);
    document.getElementById('search-input').addEventListener('input', handleSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            loadDocuments();
        }
    });
    
    
    // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    function downloadExcelFile(filePath, fileName) {
        const fileUrl = `/media/${filePath}`;
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessage(`${fileName} ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    }
    
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 500;
        `;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transition = 'opacity 0.3s';
            setTimeout(() => document.body.removeChild(messageDiv), 300);
        }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadDocuments();
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeExcelModal();
        }
    });
</script>
{% endblock %}
