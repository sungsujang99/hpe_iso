{% extends "base.html" %}

{% block title %}ìƒˆ ë¬¸ì„œ ì‘ì„± - HPE System{% endblock %}
{% block nav_documents_new %}active{% endblock %}
{% block page_title %}ìƒˆ ë¬¸ì„œ ì‘ì„±{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/documents/">ë¬¸ì„œ ëª©ë¡</a>
<span>â€º</span>
<span>ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ë¬¸ì„œ ì •ë³´ ì…ë ¥</h3>
        </div>
        
        <form id="document-form">
            <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">ë¬¸ì„œ ì¹´í…Œê³ ë¦¬ *</label>
                <select class="form-select" id="category" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <!-- í…œí”Œë¦¿ ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">ë¬¸ì„œ í…œí”Œë¦¿</label>
                <select class="form-select" id="template">
                    <option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒì‚¬í•­)</option>
                </select>
            </div>
            
            <!-- ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="form-group">
                <label class="form-label">ì—‘ì…€ ë¬¸ì„œ ì§ì ‘ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="file" id="excel-file" accept=".xlsx,.xls" class="form-control" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="clearExcelFile()" style="white-space: nowrap;">
                        íŒŒì¼ ì œê±°
                    </button>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    ğŸ’¡ í…œí”Œë¦¿ ëŒ€ì‹  ì§ì ‘ ì‘ì„±í•œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (.xlsx, .xls í˜•ì‹)
                </small>
                <div id="excel-file-info" style="margin-top: 8px; display: none; padding: 8px; background: var(--primary); border: 1px solid var(--border); border-radius: 4px;">
                    <strong>ì„ íƒëœ íŒŒì¼:</strong> <span id="excel-filename"></span> (<span id="excel-filesize"></span>)
                </div>
            </div>
            
            <!-- ë¬¸ì„œ ì •ë³´ (ì½ê¸° ì „ìš©) -->
            <div class="card" style="background: var(--primary); border: 1px solid var(--border); margin-bottom: 24px;">
                <div class="card-header">
                    <h4 style="font-size: 0.9rem; color: var(--text-muted);">ë¬¸ì„œ ì •ë³´ (ìë™ ìƒì„±)</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px;">
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">ë¬¸ì„œë²ˆí˜¸</div>
                        <div id="document-number-preview" style="font-weight: 600; color: var(--accent);">ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ìƒì„±</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">ë¬¸ì„œ ì œëª©</div>
                        <div id="document-title-preview" style="font-weight: 500;">ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ìƒì„±</div>
                    </div>
                </div>
            </div>
            
            <!-- ê´€ë ¨ ë¬¸ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ -->
            <div id="auto-fill-section" style="display: none; margin-bottom: 24px;">
                <button type="button" class="btn btn-info" onclick="loadRelatedData()" style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="margin-right: 8px;">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    ê´€ë ¨ ë¬¸ì„œì—ì„œ ë°ì´í„° ìë™ ì±„ìš°ê¸° 
                    <span style="font-size: 0.8rem; opacity: 0.8;">(ìŠ¹ì¸ëœ ê´€ë ¨ ë¬¸ì„œì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤)</span>
                </button>
            </div>
            
            <!-- ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="excel-preview-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0;">ì—‘ì…€ í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°</h4>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">ì…€ì„ ë”ë¸”í´ë¦­í•˜ì—¬ ì§ì ‘ í¸ì§‘í•˜ì„¸ìš”</span>
                </div>
                <div id="excel-preview-container" style="overflow: auto; max-height: 600px; border: 1px solid var(--border); border-radius: 8px; background: white;"></div>
            </div>
            
            <!-- ë™ì  í•„ë“œ ì˜ì—­ (ì—‘ì…€ ì—†ëŠ” í…œí”Œë¦¿ìš©) -->
            <div id="dynamic-fields">
                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin: 0 auto 16px; opacity: 0.5;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    <p>í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ ì…ë ¥ ì–‘ì‹ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
            
            <!-- ë²„íŠ¼ -->
            <div style="display: flex; gap: 16px; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
                <button type="submit" class="btn btn-primary" id="btn-save">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    ì €ì¥ (ì„ì‹œì €ì¥)
                </button>
                <button type="button" class="btn btn-success" id="btn-submit">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    ì €ì¥ í›„ ìŠ¹ì¸ ìš”ì²­
                </button>
                <a href="/documents/" class="btn btn-secondary">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
#excel-preview-container table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.85rem;
    background: white;
    color: #222;
}
#excel-preview-container th {
    background: #f0f0f0;
    border: 1px solid #ccc;
    padding: 4px 8px;
    font-weight: 600;
    text-align: center;
    color: #333;
    position: sticky;
    top: 0;
    z-index: 2;
    font-size: 0.75rem;
}
#excel-preview-container td {
    border: 1px solid #ddd;
    padding: 4px 8px;
    min-width: 60px;
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #222;
    cursor: pointer;
    position: relative;
}
#excel-preview-container td:hover {
    background: #e8f0fe;
}
#excel-preview-container td.editing {
    padding: 0;
    outline: 2px solid #1a73e8;
    background: white;
}
#excel-preview-container td.editing input {
    width: 100%;
    height: 100%;
    border: none;
    padding: 4px 8px;
    font-size: 0.85rem;
    font-family: inherit;
    outline: none;
    background: #fff;
    color: #222;
    box-sizing: border-box;
}
#excel-preview-container td.modified {
    background: #e6f4ea !important;
}
#excel-preview-container td.modified::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    border-style: solid;
    border-width: 0 8px 8px 0;
    border-color: transparent #34a853 transparent transparent;
}
#excel-preview-container tr:first-child td {
    font-weight: 600;
}
.row-header {
    background: #f8f8f8 !important;
    text-align: center;
    font-weight: 600;
    color: #666 !important;
    min-width: 40px !important;
    max-width: 40px !important;
    font-size: 0.75rem;
    cursor: default !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/xlsx.full.min.js"></script>
<script>
    let categories = [];
    let templates = [];
    let excelModifiedCells = {};
    let currentWorkbook = null;
    let currentSheetName = null;
    
    // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
    function clearExcelFile() {
        document.getElementById('excel-file').value = '';
        document.getElementById('excel-file-info').style.display = 'none';
    }
    
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            const sizeStr = fileSizeKB > 1024 ? `${fileSizeMB} MB` : `${fileSizeKB} KB`;
            
            document.getElementById('excel-filename').textContent = file.name;
            document.getElementById('excel-filesize').textContent = sizeStr;
            document.getElementById('excel-file-info').style.display = 'block';
        } else {
            document.getElementById('excel-file-info').style.display = 'none';
        }
    });
    
    async function loadCategories() {
        try {
            const response = await apiRequest('/documents/categories/');
            if (response && response.ok) {
                const data = await response.json();
                // Handle both paginated and non-paginated responses
                categories = data.results || data;
                const select = document.getElementById('category');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = `${cat.code} - ${cat.name}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load categories:', error);
        }
    }
    
    async function loadTemplates(categoryId) {
        try {
            const url = categoryId ? `/documents/templates/?category=${categoryId}` : '/documents/templates/';
            const response = await apiRequest(url);
            if (response && response.ok) {
                const data = await response.json();
                // Handle both paginated and non-paginated responses
                templates = data.results || data;
                const select = document.getElementById('template');
                select.innerHTML = '<option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒì‚¬í•­)</option>';
                templates.forEach(tmpl => {
                    const option = document.createElement('option');
                    option.value = tmpl.id;
                    option.textContent = tmpl.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load templates:', error);
        }
    }
    
    function renderDynamicFields(template) {
        const container = document.getElementById('dynamic-fields');
        
        // fields_schemaê°€ ì—†ê±°ë‚˜ ë¹ˆ ê°ì²´ë©´ ë©”ì‹œì§€ í‘œì‹œ
        if (!template || !template.fields_schema || Object.keys(template.fields_schema).length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin: 0 auto 16px; opacity: 0.5;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    <p>í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ ì…ë ¥ ì–‘ì‹ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            `;
            return;
        }
        
        const schema = template.fields_schema;
        let html = '';
        
        // fields_schema í˜•ì‹ ìë™ ê°ì§€:
        // 1) {fields: [{name, label, type, ...}]} - fixture ë°°ì—´ í˜•ì‹
        // 2) {field_name: {label, type, ...}} - ê°ì²´ í˜•ì‹
        let fieldList = [];
        if (schema.fields && Array.isArray(schema.fields)) {
            // ë°°ì—´ í˜•ì‹ (fixtureì—ì„œ ì˜¨ í˜•íƒœ)
            fieldList = schema.fields;
        } else {
            // ê°ì²´ í˜•ì‹ (key-value)
            for (const [fieldName, fieldConfig] of Object.entries(schema)) {
                if (typeof fieldConfig === 'object' && fieldConfig !== null && !Array.isArray(fieldConfig)) {
                    fieldList.push({ name: fieldName, ...fieldConfig });
                }
            }
        }
        
        if (fieldList.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                    <p>ì´ í…œí”Œë¦¿ì—ëŠ” ì…ë ¥ í•„ë“œê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                </div>
            `;
            return;
        }
        
        for (const field of fieldList) {
            const fieldName = field.name || 'unknown';
            const label = field.label || fieldName;
            const requiredMark = field.required ? ' *' : '';
            const requiredAttr = field.required ? 'required' : '';
            const placeholder = field.placeholder || '';
            
            html += `<div class="form-group">`;
            html += `<label class="form-label">${label}${requiredMark}</label>`;
            
            switch (field.type) {
                case 'textarea':
                    html += `<textarea class="form-input" id="field-${fieldName}" rows="6" placeholder="${placeholder}" ${requiredAttr} style="font-family: inherit;"></textarea>`;
                    break;
                case 'date':
                    html += `<input type="date" class="form-input" id="field-${fieldName}" ${requiredAttr}>`;
                    break;
                case 'datetime':
                    html += `<input type="datetime-local" class="form-input" id="field-${fieldName}" ${requiredAttr}>`;
                    break;
                case 'number':
                    html += `<input type="number" class="form-input" id="field-${fieldName}" placeholder="${placeholder}" ${requiredAttr}>`;
                    break;
                case 'text':
                default:
                    html += `<input type="text" class="form-input" id="field-${fieldName}" placeholder="${placeholder}" ${requiredAttr}>`;
                    break;
            }
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
    }
    
    function getContentData() {
        const templateSelect = document.getElementById('template');
        const templateId = templateSelect.value;
        
        if (!templateId) {
            return {};
        }
        
        // ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œì¸ ê²½ìš° ìˆ˜ì •ëœ ì…€ ë°ì´í„° ë°˜í™˜
        if (Object.keys(excelModifiedCells).length > 0) {
            return {
                _excel_cells: Object.values(excelModifiedCells),
                _sheet_name: currentSheetName
            };
        }
        
        const selectedTemplate = templates.find(t => t.id == templateId);
        if (!selectedTemplate || !selectedTemplate.fields_schema || Object.keys(selectedTemplate.fields_schema).length === 0) {
            return {};
        }
        
        const data = {};
        const schema = selectedTemplate.fields_schema;
        // ë°°ì—´ í˜•ì‹ê³¼ ê°ì²´ í˜•ì‹ ëª¨ë‘ ì§€ì›
        let fieldList = [];
        if (schema.fields && Array.isArray(schema.fields)) {
            fieldList = schema.fields;
        } else {
            for (const [fieldName, fieldConfig] of Object.entries(schema)) {
                if (typeof fieldConfig === 'object' && fieldConfig !== null && !Array.isArray(fieldConfig)) {
                    fieldList.push({ name: fieldName, ...fieldConfig });
                }
            }
        }
        for (const field of fieldList) {
            const el = document.getElementById(`field-${field.name}`);
            if (el) {
                const value = el.value.trim();
                if (value || field.required) {
                    data[field.name] = value;
                }
            }
        }
        
        return data;
    }
    
    async function saveDocument(submit = false) {
        const category = document.getElementById('category').value;
        const template = document.getElementById('template').value;
        const excelFileInput = document.getElementById('excel-file');
        
        if (!category) {
            alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // FormData ì‚¬ìš© (ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´)
        const formData = new FormData();
        formData.append('category', parseInt(category));
        formData.append('content_data', JSON.stringify(getContentData()));
        
        // ì œëª©ì€ ì„ íƒì‚¬í•­ (ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ìë™ ìƒì„±)
        const titlePreview = document.getElementById('document-title-preview').textContent;
        if (titlePreview && titlePreview !== 'ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ìƒì„±') {
            formData.append('title', titlePreview);
        }
        
        if (template) {
            formData.append('template', parseInt(template));
        }
        
        // ì—‘ì…€ íŒŒì¼ ì¶”ê°€
        if (excelFileInput.files.length > 0) {
            formData.append('excel_file', excelFileInput.files[0]);
        }
        
        try {
            // FormData ì‚¬ìš© - apiRequestê°€ ìë™ìœ¼ë¡œ Content-Type ìƒëµ ë° í† í° refresh ì²˜ë¦¬
            const response = await apiRequest('/documents/items/', {
                method: 'POST',
                body: formData
            });
            
            if (response && response.ok) {
                const doc = await response.json();
                
                if (submit) {
                    // ìŠ¹ì¸ ìš”ì²­
                    const submitResponse = await apiRequest(`/documents/items/${doc.id}/submit/`, {
                        method: 'POST',
                        body: JSON.stringify({})
                    });
                    
                    if (submitResponse && submitResponse.ok) {
                        alert('ë¬¸ì„œê°€ ì €ì¥ë˜ê³  ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ë¬¸ì„œëŠ” ì €ì¥ë˜ì—ˆìœ¼ë‚˜ ìŠ¹ì¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    alert('ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                window.location.href = `/documents/${doc.id}/`;
            } else {
                const error = await response.json();
                alert('ì €ì¥ ì‹¤íŒ¨: ' + JSON.stringify(error));
            }
        } catch (error) {
            console.error('Failed to save document:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    function updateDocumentPreview() {
        const categorySelect = document.getElementById('category');
        const templateSelect = document.getElementById('template');
        const categoryId = categorySelect.value;
        const templateId = templateSelect.value;
        
        if (!categoryId) {
            document.getElementById('document-number-preview').textContent = 'ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ìƒì„±';
            document.getElementById('document-title-preview').textContent = 'ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ìƒì„±';
            return;
        }
        
        const selectedCategory = categories.find(c => c.id == categoryId);
        if (!selectedCategory) return;
        
        // ë¬¸ì„œë²ˆí˜¸ ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ìƒì„±ë˜ì§€ë§Œ í˜•ì‹ë§Œ ë³´ì—¬ì¤Œ)
        const nextNum = selectedCategory.next_number || 1000;
        document.getElementById('document-number-preview').textContent = `${selectedCategory.prefix}${nextNum}`;
        
        // ì œëª© ë¯¸ë¦¬ë³´ê¸°
        if (templateId) {
            const selectedTemplate = templates.find(t => t.id == templateId);
            if (selectedTemplate) {
                document.getElementById('document-title-preview').textContent = `${selectedCategory.name} - ${selectedTemplate.name}`;
            } else {
                document.getElementById('document-title-preview').textContent = `${selectedCategory.name} ë¬¸ì„œ`;
            }
        } else {
            document.getElementById('document-title-preview').textContent = `${selectedCategory.name} ë¬¸ì„œ`;
        }
    }
    
    document.getElementById('category').addEventListener('change', (e) => {
        loadTemplates(e.target.value);
        updateDocumentPreview();
    });
    
    async function loadRelatedData() {
        const templateId = document.getElementById('template').value;
        if (!templateId) {
            alert('ë¨¼ì € í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!confirm('ê´€ë ¨ ë¬¸ì„œì—ì„œ ìŠ¹ì¸ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì–‘ì‹ì— ìë™ìœ¼ë¡œ ì±„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì´ ìˆë‹¤ë©´ ë®ì–´ì¨ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/extract_shared_data/`, {
                method: 'POST',
                body: JSON.stringify({ template: templateId })
            });
            
            if (response && response.ok) {
                const data = await response.json();
                const sharedData = data.shared_data;
                
                // ê³µìœ  ë°ì´í„°ë¥¼ í•„ë“œì— ì±„ìš°ê¸°
                let filledCount = 0;
                
                // ëª©ì  (purpose) - ì—¬ëŸ¬ ë¬¸ì„œì—ì„œ ìˆ˜ì§‘ëœ ê²½ìš° í•©ì¹˜ê¸°
                if (sharedData.purpose && sharedData.purpose.length > 0) {
                    const el = document.getElementById('field-purpose');
                    if (el) {
                        const combined = sharedData.purpose.map(item => 
                            `[${item.source}]\n${item.content}`
                        ).join('\n\n');
                        el.value = combined;
                        filledCount++;
                    }
                }
                
                // ì ìš©ë²”ìœ„ (scope)
                if (sharedData.scope && sharedData.scope.length > 0) {
                    const el = document.getElementById('field-scope');
                    if (el) {
                        const combined = sharedData.scope.map(item => 
                            `[${item.source}]\n${item.content}`
                        ).join('\n\n');
                        el.value = combined;
                        filledCount++;
                    }
                }
                
                // ì±…ì„ê³¼ ê¶Œí•œ (responsibility)
                if (sharedData.responsibility && sharedData.responsibility.length > 0) {
                    const el = document.getElementById('field-responsibility');
                    if (el) {
                        const combined = sharedData.responsibility.map(item => 
                            `[${item.source}]\n${item.content}`
                        ).join('\n\n');
                        el.value = combined;
                        filledCount++;
                    }
                }
                
                // ì—…ë¬´ì ˆì°¨ (procedure)
                if (sharedData.procedure && sharedData.procedure.length > 0) {
                    const el = document.getElementById('field-procedure');
                    if (el) {
                        const combined = sharedData.procedure.map(item => 
                            `[${item.source}]\n${item.content}`
                        ).join('\n\n');
                        el.value = combined;
                        filledCount++;
                    }
                }
                
                if (filledCount > 0) {
                    alert(`${filledCount}ê°œì˜ í•„ë“œì— ê´€ë ¨ ë¬¸ì„œ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.\n\nì„¹ì…˜: ${data.section || 'ì•Œ ìˆ˜ ì—†ìŒ'}\ní•„ìš”ì— ë”°ë¼ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”.`);
                } else {
                    alert('ê´€ë ¨ ë¬¸ì„œì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ìŠ¹ì¸ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì ˆì°¨ì„œë¥¼ ë¨¼ì € ì‘ì„±í•˜ê³  ìŠ¹ì¸ë°›ìœ¼ì‹  í›„ ë§¤ë‰´ì–¼ì„ ì‘ì„±í•˜ì‹œê±°ë‚˜,\nì§ì ‘ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            } else {
                alert('ê´€ë ¨ ë¬¸ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Failed to load related data:', error);
            alert('ê´€ë ¨ ë¬¸ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let currentUserName = '';
    let currentUserDept = '';
    async function loadCurrentUser() {
        try {
            const resp = await apiRequest('/auth/users/me/');
            if (resp && resp.ok) {
                const user = await resp.json();
                currentUserName = user.full_name || ((user.last_name || '') + (user.first_name || '')) || user.username || '';
                currentUserDept = user.department_name || '';
                console.log('User loaded:', currentUserName, '/ Dept:', currentUserDept);
            } else {
                console.error('User API failed:', resp ? resp.status : 'no response');
            }
        } catch(e) { console.error('Failed to load user:', e); }
    }
    
    // ì—‘ì…€ í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
    async function loadExcelPreview(templateFileUrl, templateName) {
        const container = document.getElementById('excel-preview-container');
        const section = document.getElementById('excel-preview-section');
        
        container.innerHTML = '<div style="text-align: center; padding: 24px; color: #666;">ì—‘ì…€ í…œí”Œë¦¿ ë¡œë”© ì¤‘...</div>';
        section.style.display = 'block';
        document.getElementById('dynamic-fields').style.display = 'none';
        
        excelModifiedCells = {};
        
        try {
            const response = await fetch(templateFileUrl);
            if (!response.ok) throw new Error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (${response.status}: ${templateFileUrl})`);
            
            const arrayBuffer = await response.arrayBuffer();
            currentWorkbook = XLSX.read(arrayBuffer, { type: 'array', cellStyles: true, cellNF: true });
            currentSheetName = currentWorkbook.SheetNames[0];
            const sheet = currentWorkbook.Sheets[currentSheetName];
            
            // ì‚¬ìš©ì ì •ë³´ê°€ ì•„ì§ ì—†ìœ¼ë©´ ë¡œë“œ
            if (!currentUserName) {
                await loadCurrentUser();
            }
            
            // í…œí”Œë¦¿ë³„ ì…€ ìë™ ì±„ìš°ê¸°
            autoFillCells(sheet, templateName);
            
            renderExcelSheet(sheet, container);
        } catch (error) {
            console.error('Excel preview error:', error);
            container.innerHTML = '<div style="text-align: center; padding: 24px; color: #d93025;">ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    // ë¹ˆ ì…€ì— ê°’ ìë™ ì±„ìš°ê¸° (í…œí”Œë¦¿ë³„)
    function autoFillCells(sheet, templateName) {
        function setCell(addr, val) {
            if (!val) return;
            const existing = sheet[addr];
            // ê°’ì´ ì—†ê±°ë‚˜ ìˆ˜ì‹ì¸ ì…€ë§Œ ë®ì–´ì“°ê¸°
            if (!existing || !existing.v || existing.f) {
                sheet[addr] = { t: 's', v: val, w: val };
            }
        }
        function setDateCell(addr) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            sheet[addr] = { t: 's', v: dateStr, w: dateStr };
        }
        
        const name = (templateName || '').trim();
        
        if (name.includes('ë‚´ë¶€ì‹¬ì‚¬') && name.includes('ì²´í¬ë¦¬ìŠ¤íŠ¸')) {
            // ë‚´ë¶€ì‹¬ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸
            setCell('K3', currentUserName);   // ì‘ì„±ì
            setCell('N6', currentUserName);   // ì‹¬ì‚¬ê´€
            setDateCell('G6');                // ë‚´ë¶€ì‹¬ì‚¬ ì‹œí–‰ì¼
            for (let r = 9; r <= 35; r++) {
                setCell('B' + r, currentUserName); // ì‹¬ì‚¬ë‚´ìš© ë‹´ë‹¹ì
            }
        } else if (name.includes('ë¶€ì í•©í’ˆ') && name.includes('ê´€ë¦¬ëŒ€ì¥')) {
            // ë¶€ì í•©í’ˆ ê´€ë¦¬ëŒ€ì¥
            setCell('Z4', currentUserDept);   // ë¶€ì„œëª… ìš°ì¸¡ ì…€
            setCell('AO4', currentUserName);  // ì‘ì„±ì ìš°ì¸¡ ì…€
        } else if (name.includes('ì—…ë¬´ë¶„ì¥í‘œ')) {
            // ì—…ë¬´ë¶„ì¥í‘œ
            setCell('J4', currentUserName);   // ì‘ì„±ì ìš°ì¸¡ ì…€
            setDateCell('J3');                // ì‘ì„±ì¼ì
        } else if (name.includes('AS') && name.includes('ê´€ë¦¬ëŒ€ì¥')) {
            // AS ê´€ë¦¬ëŒ€ì¥
            setCell('AP6', currentUserName);  // ë‹´ë‹¹ì§ì›
            setCell('AD6', currentUserDept);  // íŒ€ëª…
            setDateCell('F6');                // ì›”ë³„ ë‚ ì§œ
        }
    }
    
    // SheetJS ìƒ‰ìƒì„ CSS ìƒ‰ìƒìœ¼ë¡œ ë³€í™˜
    function xlsxColorToCSS(color) {
        if (!color) return null;
        if (color.rgb) {
            // rgbê°€ "RRGGBB" ë˜ëŠ” "AARRGGBB" í˜•íƒœ
            const rgb = color.rgb.length === 8 ? color.rgb.substring(2) : color.rgb;
            return '#' + rgb;
        }
        if (color.theme !== undefined) {
            // í…Œë§ˆ ìƒ‰ìƒ ë§¤í•‘ (Excel ê¸°ë³¸ í…Œë§ˆ)
            const themeColors = [
                '#000000', '#FFFFFF', '#44546A', '#4472C4',
                '#ED7D31', '#A5A5A5', '#FFC000', '#5B9BD5',
                '#70AD47', '#264478', '#9B57A0', '#636363'
            ];
            let base = themeColors[color.theme] || '#000000';
            // tint ì ìš© (ë°ê¸° ì¡°ì ˆ)
            if (color.tint) {
                base = applyTint(base, color.tint);
            }
            return base;
        }
        if (color.indexed !== undefined) {
            const indexedColors = [
                '#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF',
                '#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF',
                '#800000','#008000','#000080','#808000','#800080','#008080','#C0C0C0','#808080',
                '#9999FF','#993366','#FFFFCC','#CCFFFF','#660066','#FF8080','#0066CC','#CCCCFF',
                '#000080','#FF00FF','#FFFF00','#00FFFF','#800080','#800000','#008080','#0000FF',
                '#00CCFF','#CCFFFF','#CCFFCC','#FFFF99','#99CCFF','#FF99CC','#CC99FF','#FFCC99',
                '#3366FF','#33CCCC','#99CC00','#FFCC00','#FF9900','#FF6600','#666699','#969696',
                '#003366','#339966','#003300','#333300','#993300','#993366','#333399','#333333',
            ];
            return indexedColors[color.indexed] || null;
        }
        return null;
    }
    
    function applyTint(hexColor, tint) {
        let r = parseInt(hexColor.substring(1,3), 16);
        let g = parseInt(hexColor.substring(3,5), 16);
        let b = parseInt(hexColor.substring(5,7), 16);
        if (tint > 0) {
            r = Math.round(r + (255 - r) * tint);
            g = Math.round(g + (255 - g) * tint);
            b = Math.round(b + (255 - b) * tint);
        } else {
            r = Math.round(r * (1 + tint));
            g = Math.round(g * (1 + tint));
            b = Math.round(b * (1 + tint));
        }
        r = Math.min(255, Math.max(0, r));
        g = Math.min(255, Math.max(0, g));
        b = Math.min(255, Math.max(0, b));
        return '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
    }
    
    // ì…€ ìŠ¤íƒ€ì¼ì„ CSS inline styleë¡œ ë³€í™˜
    function getCellStyle(cell) {
        if (!cell || !cell.s) return '';
        const s = cell.s;
        let styles = [];
        
        // ë°°ê²½ìƒ‰
        if (s.fgColor) {
            const bg = xlsxColorToCSS(s.fgColor);
            if (bg && bg !== '#000000') styles.push(`background-color:${bg}`);
        }
        if (s.bgColor && styles.length === 0) {
            const bg = xlsxColorToCSS(s.bgColor);
            if (bg && bg !== '#000000') styles.push(`background-color:${bg}`);
        }
        // patternType fill
        if (s.patternType === 'solid' && s.fgColor) {
            const bg = xlsxColorToCSS(s.fgColor);
            if (bg) {
                styles = styles.filter(st => !st.startsWith('background-color'));
                styles.push(`background-color:${bg}`);
            }
        }
        
        // í°íŠ¸ìƒ‰
        if (s.color) {
            const fc = xlsxColorToCSS(s.color);
            if (fc) styles.push(`color:${fc}`);
        }
        
        // ë³¼ë“œ
        if (s.bold) styles.push('font-weight:bold');
        // ì´íƒ¤ë¦­
        if (s.italic) styles.push('font-style:italic');
        // ë°‘ì¤„
        if (s.underline) styles.push('text-decoration:underline');
        // í°íŠ¸ í¬ê¸°
        if (s.sz) styles.push(`font-size:${Math.max(s.sz * 0.75, 9)}px`);
        
        // ì •ë ¬
        if (s.alignment) {
            if (s.alignment.horizontal) {
                const hMap = { center: 'center', right: 'right', left: 'left', justify: 'justify' };
                if (hMap[s.alignment.horizontal]) styles.push(`text-align:${hMap[s.alignment.horizontal]}`);
            }
            if (s.alignment.vertical) {
                const vMap = { center: 'middle', top: 'top', bottom: 'bottom' };
                if (vMap[s.alignment.vertical]) styles.push(`vertical-align:${vMap[s.alignment.vertical]}`);
            }
            if (s.alignment.wrapText) styles.push('white-space:pre-wrap');
        }
        
        // í…Œë‘ë¦¬
        if (s.top || s.bottom || s.left || s.right) {
            const borderStyle = (b) => {
                if (!b || !b.style) return '';
                const color = b.color ? xlsxColorToCSS(b.color) || '#000' : '#000';
                const w = b.style === 'thin' ? '1px' : b.style === 'medium' ? '2px' : b.style === 'thick' ? '3px' : '1px';
                return `${w} solid ${color}`;
            };
            if (s.top) { const bs = borderStyle(s.top); if(bs) styles.push(`border-top:${bs}`); }
            if (s.bottom) { const bs = borderStyle(s.bottom); if(bs) styles.push(`border-bottom:${bs}`); }
            if (s.left) { const bs = borderStyle(s.left); if(bs) styles.push(`border-left:${bs}`); }
            if (s.right) { const bs = borderStyle(s.right); if(bs) styles.push(`border-right:${bs}`); }
        }
        
        return styles.join(';');
    }
    
    function renderExcelSheet(sheet, container) {
        const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
        const merges = sheet['!merges'] || [];
        const cols = sheet['!cols'] || [];
        const rows = sheet['!rows'] || [];
        
        // ë³‘í•© ì…€ ë§µ
        const mergeMap = {};
        merges.forEach(m => {
            for (let r = m.s.r; r <= m.e.r; r++) {
                for (let c = m.s.c; c <= m.e.c; c++) {
                    if (r === m.s.r && c === m.s.c) {
                        mergeMap[`${r}_${c}`] = {
                            rowspan: m.e.r - m.s.r + 1,
                            colspan: m.e.c - m.s.c + 1,
                            isOrigin: true
                        };
                    } else {
                        mergeMap[`${r}_${c}`] = { skip: true };
                    }
                }
            }
        });
        
        let html = '<table>';
        
        // ì»¬ëŸ¼ í—¤ë” (A, B, C...)
        html += '<tr><th style="min-width:40px;"></th>';
        for (let c = range.s.c; c <= range.e.c; c++) {
            const colInfo = cols[c];
            const w = colInfo && colInfo.wpx ? `${colInfo.wpx}px` : colInfo && colInfo.wch ? `${colInfo.wch * 7}px` : 'auto';
            html += `<th style="width:${w}">${XLSX.utils.encode_col(c)}</th>`;
        }
        html += '</tr>';
        
        // ë°ì´í„° í–‰
        for (let r = range.s.r; r <= range.e.r; r++) {
            const rowInfo = rows[r];
            const rh = rowInfo && rowInfo.hpx ? `height:${rowInfo.hpx}px;` : rowInfo && rowInfo.hpt ? `height:${rowInfo.hpt * 1.33}px;` : '';
            html += `<tr style="${rh}"><td class="row-header">${r + 1}</td>`;
            for (let c = range.s.c; c <= range.e.c; c++) {
                const key = `${r}_${c}`;
                const merge = mergeMap[key];
                
                if (merge && merge.skip) continue;
                
                const addr = XLSX.utils.encode_cell({ r, c });
                const cell = sheet[addr];
                const value = cell ? (cell.w || String(cell.v || '')) : '';
                const cellStyle = getCellStyle(cell);
                
                let attrs = `data-row="${r}" data-col="${c}" data-addr="${addr}" data-original="${value.replace(/"/g, '&quot;')}"`;
                if (cellStyle) attrs += ` style="${cellStyle}"`;
                
                if (merge && merge.isOrigin) {
                    if (merge.rowspan > 1) attrs += ` rowspan="${merge.rowspan}"`;
                    if (merge.colspan > 1) attrs += ` colspan="${merge.colspan}"`;
                }
                
                html += `<td ${attrs} ondblclick="startCellEdit(this)">${value}</td>`;
            }
            html += '</tr>';
        }
        
        html += '</table>';
        container.innerHTML = html;
    }
    
    function startCellEdit(td) {
        if (td.classList.contains('editing') || td.classList.contains('row-header')) return;
        
        const value = td.dataset.original !== undefined ? 
            (td.classList.contains('modified') ? td.textContent : td.dataset.original) : td.textContent;
        
        td.classList.add('editing');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = td.textContent;
        
        input.addEventListener('blur', () => finishCellEdit(td, input));
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishCellEdit(td, input);
                // ì•„ë˜ ì…€ë¡œ ì´ë™
                const nextRow = td.parentElement.nextElementSibling;
                if (nextRow) {
                    const idx = Array.from(td.parentElement.children).indexOf(td);
                    const nextTd = nextRow.children[idx];
                    if (nextTd && !nextTd.classList.contains('row-header')) {
                        startCellEdit(nextTd);
                    }
                }
            } else if (e.key === 'Tab') {
                e.preventDefault();
                finishCellEdit(td, input);
                const next = td.nextElementSibling;
                if (next && !next.classList.contains('row-header')) {
                    startCellEdit(next);
                }
            } else if (e.key === 'Escape') {
                td.classList.remove('editing');
                td.textContent = td.classList.contains('modified') ? td.textContent : td.dataset.original;
                td.innerHTML = td.dataset.original;
                if (excelModifiedCells[td.dataset.addr]) {
                    td.classList.add('modified');
                    td.textContent = excelModifiedCells[td.dataset.addr];
                }
            }
        });
        
        td.textContent = '';
        td.appendChild(input);
        input.focus();
        input.select();
    }
    
    function finishCellEdit(td, input) {
        const newValue = input.value;
        const original = td.dataset.original;
        
        td.classList.remove('editing');
        td.textContent = newValue;
        
        if (newValue !== original) {
            td.classList.add('modified');
            excelModifiedCells[td.dataset.addr] = {
                row: parseInt(td.dataset.row),
                col: parseInt(td.dataset.col),
                value: newValue,
                addr: td.dataset.addr
            };
        } else {
            td.classList.remove('modified');
            delete excelModifiedCells[td.dataset.addr];
        }
    }
    
    document.getElementById('template').addEventListener('change', (e) => {
        const templateId = e.target.value;
        if (templateId) {
            const selectedTemplate = templates.find(t => t.id == templateId);
            
            // ì—‘ì…€ íŒŒì¼ì´ ìˆëŠ” í…œí”Œë¦¿ì´ë©´ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            if (selectedTemplate && selectedTemplate.template_file && 
                (selectedTemplate.template_file.endsWith('.xlsx') || selectedTemplate.template_file.endsWith('.xls'))) {
                loadExcelPreview(selectedTemplate.template_file, selectedTemplate.name);
            } else {
                // ì—‘ì…€ ì—†ìœ¼ë©´ ê¸°ì¡´ í¼ í•„ë“œ
                document.getElementById('excel-preview-section').style.display = 'none';
                document.getElementById('dynamic-fields').style.display = 'block';
                renderDynamicFields(selectedTemplate);
            }
            
            document.getElementById('auto-fill-section').style.display = 'block';
        } else {
            document.getElementById('excel-preview-section').style.display = 'none';
            document.getElementById('dynamic-fields').style.display = 'block';
            renderDynamicFields(null);
            document.getElementById('auto-fill-section').style.display = 'none';
        }
        updateDocumentPreview();
    });
    
    document.getElementById('document-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveDocument(false);
    });
    
    document.getElementById('btn-submit').addEventListener('click', () => {
        if (confirm('ë¬¸ì„œë¥¼ ì €ì¥í•˜ê³  ìŠ¹ì¸ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìŠ¹ì¸ ìš”ì²­ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            saveDocument(true);
        }
    });
    
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCurrentUser();
        await loadCategories();
        await loadTemplates();
        
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ ë§¤ë‰´ì–¼ ì •ë³´ í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');
        const manualParam = urlParams.get('manual');
        
        if (categoryParam) {
            // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
            const categorySelect = document.getElementById('category');
            const category = categories.find(c => c.code === categoryParam);
            if (category) {
                categorySelect.value = category.id;
                // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                const event = new Event('change');
                categorySelect.dispatchEvent(event);
                
                // í…œí”Œë¦¿ ë¡œë“œ í›„ ë§¤ë‰´ì–¼ í…œí”Œë¦¿ ìë™ ì„ íƒ
                if (manualParam) {
                    setTimeout(() => {
                        const templateSelect = document.getElementById('template');
                        const template = templates.find(t => t.name.includes(manualParam));
                        if (template) {
                            templateSelect.value = template.id;
                            const templateEvent = new Event('change');
                            templateSelect.dispatchEvent(templateEvent);
                        }
                    }, 500);
                }
            }
        }
    });
</script>
{% endblock %}
