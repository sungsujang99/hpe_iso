{% extends 'base.html' %}

{% block title %}ISO 14001 환경경영{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <h2 style="margin: 0 0 8px 0; font-size: 1.75rem; font-weight: 600;">ISO 14001 환경경영 시스템</h2>
    <p style="margin: 0; color: var(--text-muted);">환경경영 매뉴얼 및 관련 절차서</p>
</div>

<div style="display: grid; grid-template-columns: 350px 1fr; gap: 24px; height: calc(100vh - 200px);">
    <!-- 문서 목록 (왼쪽) -->
    <div class="card" style="height: 100%; overflow-y: auto; padding: 0;">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: white; z-index: 10;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">문서 목록</h3>
        </div>
        
        <!-- 매뉴얼 섹션 -->
        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">매뉴얼</div>
            <div id="manual-list"></div>
        </div>
        
        <!-- 절차서 섹션 -->
        <div style="padding: 16px;">
            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">절차서</div>
            <div id="procedure-list"></div>
        </div>
        
        <!-- 지침서 섹션 -->
        <div style="padding: 16px; border-top: 1px solid var(--border);">
            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">지침서</div>
            <div id="instruction-list"></div>
        </div>
    </div>
    
    <!-- 문서 뷰어 (오른쪽) -->
    <div class="card" style="height: 100%; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 id="selected-doc-title" style="margin: 0; font-size: 1.1rem; font-weight: 600;">문서를 선택하세요</h3>
                <p id="selected-doc-number" style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 0.9rem;"></p>
            </div>
            <div id="doc-actions" style="display: none; gap: 8px;">
                <button id="btn-download-pdf" class="btn btn-primary" style="display: none;" onclick="downloadSelectedPDF()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    PDF 다운로드
                </button>
                <a id="btn-detail" href="#" class="btn btn-secondary">상세보기</a>
            </div>
        </div>
        
        <div id="doc-viewer" style="flex: 1; overflow: auto; padding: 24px; background: #f9f9f9;">
            <div style="text-align: center; color: var(--text-muted); padding: 60px 0;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64" style="margin: 0 auto 16px; opacity: 0.3;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <p style="font-size: 1.1rem;">왼쪽 목록에서 문서를 선택하세요</p>
            </div>
        </div>
    </div>
</div>

<style>
.doc-item {
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.doc-item:hover {
    background: var(--bg-hover);
    border-color: var(--primary);
    transform: translateX(4px);
}

.doc-item.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.doc-item.active .doc-status {
    color: rgba(255, 255, 255, 0.8) !important;
}

.doc-number {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 4px;
}

.doc-title {
    font-size: 0.9rem;
    margin-bottom: 4px;
    line-height: 1.3;
}

.doc-status {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-approved {
    background: #d1f4e0;
    color: #0d7d3f;
}

.status-pending {
    background: #fff4d1;
    color: #8b6914;
}

.status-draft {
    background: #e5e7eb;
    color: #4b5563;
}
</style>

<script>
    let documents = [];
    let selectedDocumentId = null;
    
    // API 요청 헬퍼
    async function apiRequest(url, options = {}) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return null;
        }
        
        const response = await fetch(`/api/v1${url}`, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
        });
        
        if (response.status === 401) {
            localStorage.removeItem('access_token');
            window.location.href = '/login/';
            return null;
        }
        
        return response;
    }
    
    // 상태 텍스트 변환
    function getStatusText(status) {
        const statusMap = {
            'draft': '작성중',
            'pending_review': '검토대기',
            'pending_approval': '승인대기',
            'approved': '승인완료',
            'rejected': '반려'
        };
        return statusMap[status] || status;
    }
    
    // 상태 클래스 변환
    function getStatusClass(status) {
        if (status === 'approved') return 'status-approved';
        if (status === 'pending_review' || status === 'pending_approval') return 'status-pending';
        return 'status-draft';
    }
    
    // ISO 14001 문서 로드
    async function loadDocuments() {
        try {
            // HP-EM (매뉴얼), HP-EP (절차서), HP-EI (지침서) 카테고리의 모든 문서 가져오기
            const response = await apiRequest('/documents/items/?category__code__in=HP-EM,HP-EP,HP-EI&page_size=100');
            if (response && response.ok) {
                const data = await response.json();
                documents = data.results || data;
                
                // 카테고리별로 분류
                const manuals = documents.filter(doc => doc.category_code === 'HP-EM');
                const procedures = documents.filter(doc => doc.category_code === 'HP-EP');
                const instructions = documents.filter(doc => doc.category_code === 'HP-EI');
                
                // 리스트 렌더링
                renderDocumentList('manual-list', manuals);
                renderDocumentList('procedure-list', procedures);
                renderDocumentList('instruction-list', instructions);
            }
        } catch (error) {
            console.error('Failed to load documents:', error);
        }
    }
    
    // 문서 리스트 렌더링
    function renderDocumentList(elementId, docs) {
        const container = document.getElementById(elementId);
        if (docs.length === 0) {
            container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 0.9rem;">문서 없음</div>';
            return;
        }
        
        container.innerHTML = docs.map(doc => `
            <div class="doc-item" onclick="selectDocument('${doc.id}')">
                <div class="doc-number">${doc.document_number}</div>
                <div class="doc-title">${doc.title}</div>
                <div class="doc-status">
                    <span class="status-badge ${getStatusClass(doc.status)}">${getStatusText(doc.status)}</span>
                    <span style="margin-left: 8px;">${new Date(doc.created_at).toLocaleDateString('ko-KR')}</span>
                </div>
            </div>
        `).join('');
    }
    
    // 문서 선택
    async function selectDocument(documentId) {
        selectedDocumentId = documentId;
        
        // 활성 상태 표시
        document.querySelectorAll('.doc-item').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        const doc = documents.find(d => d.id === documentId);
        if (!doc) return;
        
        // 문서 정보 표시
        document.getElementById('selected-doc-title').textContent = doc.title;
        document.getElementById('selected-doc-number').textContent = `${doc.document_number} | ${getStatusText(doc.status)}`;
        
        // 액션 버튼 표시
        const actionsDiv = document.getElementById('doc-actions');
        actionsDiv.style.display = 'flex';
        
        // 승인 완료된 문서만 PDF 다운로드 가능
        const pdfBtn = document.getElementById('btn-download-pdf');
        pdfBtn.style.display = doc.status === 'approved' ? 'flex' : 'none';
        
        // 상세보기 링크
        document.getElementById('btn-detail').href = `/documents/${documentId}/`;
        
        // 웹 미리보기 로드
        await loadDocumentPreview(documentId);
    }
    
    // 웹 미리보기 로드
    async function loadDocumentPreview(documentId) {
        const viewer = document.getElementById('doc-viewer');
        viewer.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--text-muted);">문서 로딩 중...</p></div>';
        
        try {
            const response = await apiRequest(`/documents/items/${documentId}/`);
            if (response && response.ok) {
                const doc = await response.json();
                
                let contentHtml = '';
                
                // 문서 헤더
                contentHtml += `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 32px; max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 24px;">
                            <h2 style="margin: 0 0 8px; font-size: 1.5rem;">${doc.title}</h2>
                            <p style="margin: 0; color: #666;">${doc.document_number} | Rev.${doc.revision}</p>
                            <span class="status-badge ${getStatusClass(doc.status)}" style="margin-top: 8px; display: inline-block;">${getStatusText(doc.status)}</span>
                        </div>
                `;
                
                // 문서 정보
                contentHtml += `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 0.9rem;">
                        <tr>
                            <td style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600; width: 120px;">카테고리</td>
                            <td style="padding: 8px 12px; border: 1px solid #ddd;">${doc.category_detail?.name || '-'}</td>
                            <td style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600; width: 120px;">작성자</td>
                            <td style="padding: 8px 12px; border: 1px solid #ddd;">${doc.created_by_name || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600;">작성일</td>
                            <td style="padding: 8px 12px; border: 1px solid #ddd;">${new Date(doc.created_at).toLocaleDateString('ko-KR')}</td>
                            <td style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600;">상태</td>
                            <td style="padding: 8px 12px; border: 1px solid #ddd;">${getStatusText(doc.status)}</td>
                        </tr>
                    </table>
                `;
                
                // 문서 내용
                if (doc.content_data && Object.keys(doc.content_data).length > 0) {
                    contentHtml += '<h4 style="margin: 24px 0 12px; border-bottom: 1px solid #ddd; padding-bottom: 8px;">문서 내용</h4>';
                    
                    const labels = {
                        'occurrence_date': '발생 일시', 'nonconformity_content': '부적합 내용',
                        'cause_analysis': '원인 분석', 'corrective_action': '시정 조치 계획',
                        'preventive_action': '예방 조치', 'target_date': '목표 완료일',
                        'remarks': '비고', 'audit_date': '내부심사 시행일',
                        'auditor': '심사원', 'department': '심사대상 부서'
                    };
                    
                    for (const [key, value] of Object.entries(doc.content_data)) {
                        if (!value) continue;
                        const label = labels[key] || key;
                        contentHtml += `
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: #555; margin-bottom: 4px;">${label}</div>
                                <div style="padding: 10px 14px; background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; white-space: pre-wrap;">${value}</div>
                            </div>
                        `;
                    }
                } else {
                    contentHtml += '<p style="color: #999; text-align: center; padding: 20px;">문서 내용이 없습니다.</p>';
                }
                
                // 승인 정보
                if (doc.status === 'approved') {
                    contentHtml += `
                        <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #333;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <tr>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; background: #f5f5f5; font-weight: 600; width: 33%;">작성</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; background: #f5f5f5; font-weight: 600; width: 33%;">검토</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; background: #f5f5f5; font-weight: 600; width: 33%;">승인</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${doc.created_by_name || '-'}</td>
                                    <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${doc.reviewed_by_name || '-'}</td>
                                    <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${doc.approved_by_name || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                }
                
                // 미승인 안내
                if (doc.status !== 'approved') {
                    contentHtml += `
                        <div style="margin-top: 24px; padding: 16px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; text-align: center;">
                            <p style="margin: 0; color: #856404; font-size: 0.9rem;">승인 완료 후 PDF 다운로드가 가능합니다.</p>
                        </div>
                    `;
                }
                
                contentHtml += '</div>';
                viewer.innerHTML = contentHtml;
            } else {
                viewer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">문서를 불러올 수 없습니다.</div>';
            }
        } catch (error) {
            console.error('Failed to load document:', error);
            viewer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">문서 로딩 실패</div>';
        }
    }
    
    // PDF 다운로드 (승인된 문서만)
    async function downloadSelectedPDF() {
        if (!selectedDocumentId) return;
        
        const doc = documents.find(d => d.id === selectedDocumentId);
        if (doc && doc.status !== 'approved') {
            alert('승인 완료된 문서만 PDF 다운로드가 가능합니다.');
            return;
        }
        
        try {
            const response = await apiRequest(`/documents/items/${selectedDocumentId}/download_pdf/`);
            if (response && response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const filename = doc ? `${doc.document_number}.pdf` : 'document.pdf';
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('PDF 다운로드에 실패했습니다.');
            }
        } catch (error) {
            console.error('Failed to download PDF:', error);
            alert('PDF 다운로드 중 오류가 발생했습니다.');
        }
    }
    
    // 페이지 로드 시
    document.addEventListener('DOMContentLoaded', loadDocuments);
</script>
{% endblock %}
