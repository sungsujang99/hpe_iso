{% extends "base.html" %}
{% load static %}

{% block title %}ì—‘ì…€ ë¬¸ì„œ ë³´ê¸°{% endblock %}
{% block page_title %}ì—‘ì…€ ë¬¸ì„œ ë³´ê¸°{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/documents/">ë¬¸ì„œ ëª©ë¡</a>
<span>â€º</span>
<span id="doc-title">ì—‘ì…€ ë¬¸ì„œ</span>
{% endblock %}

{% block content %}
<!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ - ë¡œì»¬ íŒŒì¼ -->
<script src="{% static 'js/xlsx.full.min.js' %}"></script>

<style>
    #excel-container {
        width: 100%;
        height: calc(100vh - 200px);
        overflow: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    
    #excel-container table {
        border-collapse: collapse;
        font-family: 'Malgun Gothic', 'Arial', sans-serif;
        font-size: 12pt;
        width: auto;
        color: #000000 !important;
    }
    
    #excel-container th,
    #excel-container td {
        border: 1px solid #a0a0a0;
        padding: 6px 10px;
        min-width: 80px;
        white-space: pre-wrap;
        text-align: left;
        background: white;
        color: #000000 !important;
    }
    
    #excel-container th {
        background: #d9e2f3 !important;
        font-weight: 700;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        color: #000000 !important;
    }
    
    #excel-container tr:hover td {
        background: #fff3cd !important;
    }
    
    #excel-container td:first-child {
        font-weight: 600;
        background: #f0f0f0;
    }
</style>
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header" style="background: #217346; color: white; display: flex; justify-content: space-between; align-items: center; padding: 20px;">
        <div>
            <h2 id="doc-title-header" style="font-size: 1.3rem; margin: 0;">ğŸ“Š ì—‘ì…€ ë¬¸ì„œ</h2>
            <p id="doc-info" style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="window.print()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ–¨ï¸ ì¸ì‡„
            </button>
            <a id="download-link" href="#" download class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ“¥ ì›ë³¸ ë‹¤ìš´ë¡œë“œ
            </a>
            <a href="/documents/" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ“‹ ëª©ë¡
            </a>
        </div>
    </div>
</div>

<!-- ì—‘ì…€ íŒŒì¼ ë Œë”ë§ ì˜ì—­ -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div id="loading" style="text-align: center; padding: 100px; color: #666;">
        <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“Š</div>
        <p style="font-size: 1.2rem; font-weight: 600;">ì—‘ì…€ íŒŒì¼ ë¡œë”© ì¤‘...</p>
    </div>
    <div id="excel-container" style="display: none;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const documentId = window.location.pathname.split('/').filter(Boolean)[2];
    let currentDoc = null;
    let workbook = null;
    
    async function loadExcelFile() {
        try {
            // 1. ë¬¸ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const response = await apiRequest(`/inventory/excel-documents/${documentId}/items/`);
            
            if (!response || !response.ok) {
                showError('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = await response.json();
            currentDoc = data.document;
            
            // ì œëª© ë° ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('doc-title').textContent = currentDoc.title;
            document.getElementById('doc-title-header').textContent = 'ğŸ“Š ' + currentDoc.title;
            document.getElementById('doc-info').textContent = `${currentDoc.doc_type_display} â€¢ ${currentDoc.file_name}`;
            document.title = currentDoc.title + ' - HPE System';
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
            const downloadLink = document.getElementById('download-link');
            downloadLink.href = `/media/${currentDoc.file_path}`;
            downloadLink.download = currentDoc.file_name;
            
            // 2. ì‹¤ì œ ì—‘ì…€ íŒŒì¼ ë¡œë“œ
            const fileUrl = `/media/${currentDoc.file_path}`;
            console.log('ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì¤‘:', fileUrl);
            
            const fileResponse = await fetch(fileUrl);
            if (!fileResponse.ok) {
                throw new Error('ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const arrayBuffer = await fileResponse.arrayBuffer();
            
            // 3. SheetJSë¡œ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
            workbook = XLSX.read(arrayBuffer, {
                type: 'array',
                cellStyles: true,
                cellDates: true
            });
            
            // 4. ì²« ë²ˆì§¸ ì‹œíŠ¸ ë Œë”ë§
            renderExcelSheet(workbook, workbook.SheetNames[0]);
            
        } catch (error) {
            console.error('Failed to load excel file:', error);
            showError('ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
    
    function renderExcelSheet(wb, sheetName) {
        const sheet = wb.Sheets[sheetName];
        
        // HTML í…Œì´ë¸”ë¡œ ë³€í™˜
        const htmlTable = XLSX.utils.sheet_to_html(sheet, {
            id: 'excel-table',
            editable: false
        });
        
        // ì»¨í…Œì´ë„ˆì— ì‚½ì…
        const container = document.getElementById('excel-container');
        container.innerHTML = htmlTable;
        
        // ë¡œë”© ìˆ¨ê¸°ê³  ì»¨í…Œì´ë„ˆ í‘œì‹œ
        document.getElementById('loading').style.display = 'none';
        container.style.display = 'block';
        
        console.log('âœ… ì—‘ì…€ ì‹œíŠ¸ ë Œë”ë§ ì™„ë£Œ:', sheetName);
    }
    
    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <div style="text-align: center; padding: 48px;">
                <span style="font-size: 3rem; display: block; margin-bottom: 16px;">âŒ</span>
                <p style="color: #c43434; font-size: 1.1rem; font-weight: 600;">${message}</p>
                <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        `;
    }
    
    // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
    let xlsxWaitCount = 0;
    function waitForXLSX() {
        if (typeof XLSX !== 'undefined') {
            console.log('âœ… ë¡œì»¬ XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
            loadExcelFile();
        } else {
            xlsxWaitCount++;
            if (xlsxWaitCount > 50) { // 5ì´ˆ ì´ˆê³¼
                console.error('âŒ ë¡œì»¬ XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
                console.error('ê²½ë¡œ í™•ì¸: /static/js/xlsx.full.min.js');
                showError('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                return;
            }
            if (xlsxWaitCount % 10 === 0) { // 1ì´ˆë§ˆë‹¤ ë¡œê·¸
                console.log('â³ ë¡œì»¬ XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘... (' + (xlsxWaitCount/10) + 'ì´ˆ)');
            }
            setTimeout(waitForXLSX, 100);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        waitForXLSX();
    });
</script>

<style>
@media print {
    .sidebar, .header, .btn, button, .breadcrumb {
        display: none !important;
    }
    
    .main-wrapper {
        margin-left: 0 !important;
        padding: 0 !important;
    }
    
    #excel-container {
        border: none !important;
        height: auto !important;
    }
    
    #excel-container table {
        page-break-inside: auto;
    }
    
    #excel-container tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
}
</style>
{% endblock %}
