{% extends "base.html" %}
{% load static %}

{% block title %}ì—‘ì…€ ë¬¸ì„œ ë³´ê¸°{% endblock %}
{% block page_title %}ì—‘ì…€ ë¬¸ì„œ ë³´ê¸°{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/documents/">ë¬¸ì„œ ëª©ë¡</a>
<span>â€º</span>
<span id="doc-title">ì—‘ì…€ ë¬¸ì„œ</span>
{% endblock %}

{% block content %}
<!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ - ë¡œì»¬ íŒŒì¼ -->
<script src="{% static 'js/xlsx.full.min.js' %}"></script>

<style>
    #excel-container {
        width: 100%;
        height: calc(100vh - 250px);
        overflow: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    
    #excel-container table {
        border-collapse: collapse;
        font-family: 'Malgun Gothic', 'Arial', sans-serif;
        font-size: 11pt;
        width: auto;
        color: #000000 !important;
    }
    
    #excel-container th,
    #excel-container td {
        border: 1px solid #a0a0a0;
        padding: 4px 8px;
        min-width: 60px;
        white-space: pre-wrap;
        text-align: left;
        background: white;
        color: #000000 !important;
        cursor: cell;
    }
    
    #excel-container th {
        background: #d9e2f3 !important;
        font-weight: 700;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        color: #000000 !important;
        cursor: default;
    }
    
    #excel-container tr:hover td {
        background: #f5f9ff !important;
    }
    
    #excel-container td:first-child {
        font-weight: 600;
        background: #f0f0f0;
        cursor: default;
    }
    
    /* í¸ì§‘ ëª¨ë“œ */
    #excel-container td.editing {
        background: #fffde7 !important;
        outline: 2px solid #1976d2;
        outline-offset: -1px;
        padding: 2px;
    }
    
    #excel-container td.editing input {
        width: 100%;
        height: 100%;
        border: none;
        outline: none;
        font-family: inherit;
        font-size: inherit;
        background: transparent;
        padding: 2px 6px;
        box-sizing: border-box;
    }
    
    /* ìˆ˜ì •ëœ ì…€ í‘œì‹œ */
    #excel-container td.modified {
        background: #e8f5e9 !important;
        position: relative;
    }
    
    #excel-container td.modified::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-top: 8px solid #4caf50;
        border-left: 8px solid transparent;
    }
    
    /* ìƒíƒœ ë°” */
    #status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: #f5f5f5;
        border-top: 1px solid #ddd;
        font-size: 0.85rem;
        color: #666;
    }
    
    /* ì €ì¥ ë²„íŠ¼ ê¹œë¹¡ì„ */
    .btn-save-active {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
        50% { box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); }
        100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
</style>

<!-- íˆ´ë°” -->
<div class="card" style="margin-bottom: 0; border-radius: 8px 8px 0 0;">
    <div class="card-header" style="background: #217346; color: white; display: flex; justify-content: space-between; align-items: center; padding: 16px 20px;">
        <div>
            <h2 id="doc-title-header" style="font-size: 1.3rem; margin: 0;">ì—‘ì…€ ë¬¸ì„œ</h2>
            <p id="doc-info" style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.85rem;"></p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="edit-status" style="font-size: 0.85rem; opacity: 0.9;"></span>
            <button id="btn-save" class="btn" onclick="saveChanges()" style="background: #4caf50; color: white; border: none; display: none; font-weight: 600;">
                ğŸ’¾ ì €ì¥
            </button>
            <button class="btn btn-secondary" onclick="window.print()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ–¨ï¸ ì¸ì‡„
            </button>
            <a id="download-link" href="#" download class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ“¥ ë‹¤ìš´ë¡œë“œ
            </a>
            <a href="/documents/" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">
                ğŸ“‹ ëª©ë¡
            </a>
        </div>
    </div>
</div>

<!-- ì—‘ì…€ íŒŒì¼ ë Œë”ë§ ì˜ì—­ -->
<div class="card" style="padding: 0; overflow: hidden; border-radius: 0; margin-bottom: 0;">
    <div id="loading" style="text-align: center; padding: 100px; color: #666;">
        <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“Š</div>
        <p style="font-size: 1.2rem; font-weight: 600;">ì—‘ì…€ íŒŒì¼ ë¡œë”© ì¤‘...</p>
    </div>
    <div id="excel-container" style="display: none;"></div>
</div>

<!-- ìƒíƒœ ë°” -->
<div id="status-bar" style="border-radius: 0 0 8px 8px;">
    <span id="cell-info">ì…€ì„ í´ë¦­í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
    <span id="change-count"></span>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const documentId = window.location.pathname.split('/').filter(Boolean)[2];
    let currentDoc = null;
    let workbook = null;
    let currentSheet = null;
    let modifiedCells = {};  // { "í–‰-ì—´": { row, col, value, originalValue } }
    let editingCell = null;
    
    async function loadExcelFile() {
        try {
            const response = await apiRequest(`/inventory/excel-documents/${documentId}/items/`);
            
            if (!response || !response.ok) {
                showError('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = await response.json();
            currentDoc = data.document;
            
            document.getElementById('doc-title').textContent = currentDoc.title;
            document.getElementById('doc-title-header').textContent = currentDoc.title;
            document.getElementById('doc-info').textContent = `${currentDoc.doc_type_display} | ${currentDoc.file_name} | ì…€ì„ ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘`;
            document.title = currentDoc.title + ' - HPE System';
            
            const downloadLink = document.getElementById('download-link');
            downloadLink.href = `/media/${currentDoc.file_path}`;
            downloadLink.download = currentDoc.file_name;
            
            const fileUrl = `/media/${currentDoc.file_path}`;
            const fileResponse = await fetch(fileUrl);
            if (!fileResponse.ok) {
                throw new Error('ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const arrayBuffer = await fileResponse.arrayBuffer();
            
            workbook = XLSX.read(arrayBuffer, {
                type: 'array',
                cellStyles: true,
                cellDates: true
            });
            
            currentSheet = workbook.SheetNames[0];
            renderEditableSheet(workbook, currentSheet);
            
        } catch (error) {
            console.error('Failed to load excel file:', error);
            showError('ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
    
    function renderEditableSheet(wb, sheetName) {
        const sheet = wb.Sheets[sheetName];
        const container = document.getElementById('excel-container');
        
        // ì‹œíŠ¸ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
        const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
        
        let html = '<table id="excel-table">';
        
        // í—¤ë” í–‰ (ì—´ ë²ˆí˜¸)
        html += '<thead><tr><th style="min-width:40px; background:#c0c0c0 !important;">#</th>';
        for (let col = range.s.c; col <= range.e.c; col++) {
            const colLetter = XLSX.utils.encode_col(col);
            html += `<th style="min-width:80px;">${colLetter}</th>`;
        }
        html += '</tr></thead>';
        
        // ë°ì´í„° í–‰
        html += '<tbody>';
        for (let row = range.s.r; row <= range.e.r; row++) {
            html += `<tr>`;
            html += `<td style="text-align:center; background:#f0f0f0 !important; font-weight:600; cursor:default; min-width:40px;">${row + 1}</td>`;
            
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddr = XLSX.utils.encode_cell({ r: row, c: col });
                const cell = sheet[cellAddr];
                let value = '';
                let displayValue = '';
                
                if (cell) {
                    if (cell.t === 'n') {
                        value = cell.v;
                        displayValue = cell.w || String(cell.v);
                    } else if (cell.t === 'd') {
                        value = cell.w || '';
                        displayValue = value;
                    } else {
                        value = cell.v || '';
                        displayValue = cell.w || String(cell.v || '');
                    }
                }
                
                html += `<td data-row="${row}" data-col="${col}" data-addr="${cellAddr}" data-original="${encodeURIComponent(String(value))}" ondblclick="startEdit(this)" title="ì…€ ${cellAddr} - ë”ë¸”í´ë¦­ìœ¼ë¡œ í¸ì§‘">${displayValue}</td>`;
            }
            html += '</tr>';
        }
        html += '</tbody></table>';
        
        container.innerHTML = html;
        document.getElementById('loading').style.display = 'none';
        container.style.display = 'block';
        
        console.log('âœ… í¸ì§‘ ê°€ëŠ¥í•œ ì—‘ì…€ ì‹œíŠ¸ ë Œë”ë§ ì™„ë£Œ:', sheetName);
    }
    
    // ì…€ í¸ì§‘ ì‹œì‘
    function startEdit(td) {
        if (editingCell) {
            finishEdit(editingCell);
        }
        
        editingCell = td;
        const currentValue = td.textContent;
        const addr = td.dataset.addr;
        
        td.classList.add('editing');
        td.innerHTML = `<input type="text" value="${currentValue}" onblur="finishEdit(this.parentElement)" onkeydown="handleEditKey(event, this)">`;
        
        const input = td.querySelector('input');
        input.focus();
        input.select();
        
        document.getElementById('cell-info').textContent = `í¸ì§‘ ì¤‘: ${addr} | ê°’: ${currentValue}`;
    }
    
    // ì…€ í¸ì§‘ ì™„ë£Œ
    function finishEdit(td) {
        if (!td || !td.classList.contains('editing')) return;
        
        const input = td.querySelector('input');
        if (!input) return;
        
        const newValue = input.value;
        const originalValue = decodeURIComponent(td.dataset.original);
        const row = parseInt(td.dataset.row);
        const col = parseInt(td.dataset.col);
        const addr = td.dataset.addr;
        
        td.classList.remove('editing');
        td.textContent = newValue;
        
        // ê°’ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (String(newValue) !== String(originalValue)) {
            td.classList.add('modified');
            modifiedCells[`${row}-${col}`] = {
                row: row,
                col: col,
                addr: addr,
                value: newValue,
                originalValue: originalValue
            };
        } else {
            td.classList.remove('modified');
            delete modifiedCells[`${row}-${col}`];
        }
        
        editingCell = null;
        updateChangeCount();
        
        document.getElementById('cell-info').textContent = 
            Object.keys(modifiedCells).length > 0 
                ? `ìˆ˜ì •ëœ ì…€: ${Object.keys(modifiedCells).length}ê°œ | ğŸ’¾ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”` 
                : 'ì…€ì„ ë”ë¸”í´ë¦­í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
    }
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    function handleEditKey(event, input) {
        if (event.key === 'Enter') {
            event.preventDefault();
            finishEdit(input.parentElement);
            
            // ì•„ë˜ ì…€ë¡œ ì´ë™
            const td = input.parentElement;
            const row = parseInt(td.dataset.row);
            const col = parseInt(td.dataset.col);
            const nextTd = document.querySelector(`td[data-row="${row + 1}"][data-col="${col}"]`);
            if (nextTd) {
                startEdit(nextTd);
            }
        } else if (event.key === 'Escape') {
            event.preventDefault();
            const td = input.parentElement;
            const originalValue = decodeURIComponent(td.dataset.original);
            td.classList.remove('editing');
            td.textContent = originalValue;
            editingCell = null;
        } else if (event.key === 'Tab') {
            event.preventDefault();
            finishEdit(input.parentElement);
            
            // ì˜¤ë¥¸ìª½ ì…€ë¡œ ì´ë™
            const td = input.parentElement;
            const row = parseInt(td.dataset.row);
            const col = parseInt(td.dataset.col);
            const nextTd = document.querySelector(`td[data-row="${row}"][data-col="${col + 1}"]`);
            if (nextTd) {
                startEdit(nextTd);
            }
        }
    }
    
    // ë³€ê²½ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    function updateChangeCount() {
        const count = Object.keys(modifiedCells).length;
        const countEl = document.getElementById('change-count');
        const saveBtn = document.getElementById('btn-save');
        
        if (count > 0) {
            countEl.textContent = `${count}ê°œ ì…€ ìˆ˜ì •ë¨`;
            countEl.style.color = '#4caf50';
            countEl.style.fontWeight = '600';
            saveBtn.style.display = 'inline-flex';
            saveBtn.classList.add('btn-save-active');
        } else {
            countEl.textContent = '';
            saveBtn.style.display = 'none';
            saveBtn.classList.remove('btn-save-active');
        }
    }
    
    // ë³€ê²½ì‚¬í•­ ì €ì¥
    async function saveChanges() {
        const count = Object.keys(modifiedCells).length;
        if (count === 0) {
            alert('ìˆ˜ì •ëœ ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!confirm(`${count}ê°œì˜ ì…€ì„ ìˆ˜ì •í•©ë‹ˆë‹¤. ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }
        
        const saveBtn = document.getElementById('btn-save');
        saveBtn.textContent = 'â³ ì €ì¥ ì¤‘...';
        saveBtn.disabled = true;
        
        try {
            // ìˆ˜ì •ëœ ì…€ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡
            const cellUpdates = Object.values(modifiedCells).map(cell => ({
                row: cell.row + 1,  // openpyxlì€ 1-based
                col: cell.col + 1,  // openpyxlì€ 1-based
                value: cell.value
            }));
            
            const response = await apiRequest(`/inventory/excel-documents/${documentId}/update_cells/`, {
                method: 'POST',
                body: JSON.stringify({
                    sheet_name: currentSheet,
                    cells: cellUpdates
                })
            });
            
            if (response && response.ok) {
                const result = await response.json();
                
                // ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™”
                document.querySelectorAll('td.modified').forEach(td => {
                    td.classList.remove('modified');
                    // ìƒˆ original ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    td.dataset.original = encodeURIComponent(td.textContent);
                });
                modifiedCells = {};
                updateChangeCount();
                
                document.getElementById('cell-info').textContent = `âœ… ${count}ê°œ ì…€ ì €ì¥ ì™„ë£Œ!`;
                document.getElementById('edit-status').textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${new Date().toLocaleTimeString()}`;
                
                alert(`âœ… ${count}ê°œ ì…€ì´ ì—‘ì…€ íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                const error = await response.json();
                alert('ì €ì¥ ì‹¤íŒ¨: ' + (error.error || JSON.stringify(error)));
            }
        } catch (error) {
            console.error('Save failed:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
            saveBtn.textContent = 'ğŸ’¾ ì €ì¥';
            saveBtn.disabled = false;
        }
    }
    
    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <div style="text-align: center; padding: 48px;">
                <span style="font-size: 3rem; display: block; margin-bottom: 16px;">âŒ</span>
                <p style="color: #c43434; font-size: 1.1rem; font-weight: 600;">${message}</p>
                <a href="/documents/" class="btn btn-secondary" style="margin-top: 16px;">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        `;
    }
    
    // í˜ì´ì§€ ë– ë‚˜ê¸° ì „ ê²½ê³ 
    window.addEventListener('beforeunload', function(e) {
        if (Object.keys(modifiedCells).length > 0) {
            e.preventDefault();
            e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.';
            return e.returnValue;
        }
    });
    
    // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ëŒ€ê¸°
    let xlsxWaitCount = 0;
    function waitForXLSX() {
        if (typeof XLSX !== 'undefined') {
            console.log('âœ… XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
            loadExcelFile();
        } else {
            xlsxWaitCount++;
            if (xlsxWaitCount > 50) {
                showError('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            setTimeout(waitForXLSX, 100);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        waitForXLSX();
    });
</script>

<style>
@media print {
    .sidebar, .header, .btn, button, .breadcrumb, #status-bar {
        display: none !important;
    }
    .main-wrapper { margin-left: 0 !important; padding: 0 !important; }
    #excel-container { border: none !important; height: auto !important; }
    #excel-container table { page-break-inside: auto; }
    #excel-container tr { page-break-inside: avoid; }
}
</style>
{% endblock %}
