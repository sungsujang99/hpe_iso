{% extends "base.html" %}

{% block title %}ì¶œê³  ì²˜ë¦¬ - HPE System{% endblock %}
{% block nav_inventory_out %}active{% endblock %}
{% block page_title %}ì¶œê³  ì²˜ë¦¬{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/inventory/">ì¬ê³ ê´€ë¦¬</a>
<span>â€º</span>
<span>ì¶œê³  ì²˜ë¦¬</span>
{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ì¶œê³  ì •ë³´ ì…ë ¥</h3>
        </div>
        
        <!-- ë°”ì½”ë“œ ìŠ¤ìº” ì˜ì—­ -->
        <div class="card" style="background: linear-gradient(135deg, var(--warning-light) 0%, rgba(245, 158, 11, 0.1) 100%); margin-bottom: 24px;">
            <div class="form-group">
                <label class="form-label">ë°”ì½”ë“œ ìŠ¤ìº”</label>
                <input type="text" 
                       class="form-input" 
                       id="barcode-input" 
                       placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš” (ì—¬ëŸ¬ ë²ˆ ìŠ¤ìº” ê°€ëŠ¥)" 
                       autocomplete="off"
                       style="font-size: 1.1rem; padding: 16px 20px; text-align: center; letter-spacing: 2px;">
                <div style="text-align: center; margin-top: 8px;">
                    <span style="color: var(--text-muted); font-size: 0.8rem;">
                        ğŸ’¡ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤
                    </span>
                </div>
            </div>
        </div>
        
        <!-- ìŠ¤ìº”ëœ í’ˆëª© ëª©ë¡ -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">ì¶œê³  í’ˆëª© ëª©ë¡</h3>
                <span class="badge badge-warning" id="item-count">0ê°œ</span>
            </div>
            <div id="scanned-items-list" style="min-height: 200px;">
                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin: 0 auto 16px; opacity: 0.5;">
                        <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                        <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                        <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                        <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                        <line x1="7" y1="12" x2="17" y2="12"></line>
                    </svg>
                    <p>ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ í’ˆëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
        
        <!-- ê³µí†µ ì •ë³´ -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">ê³µí†µ ì •ë³´</h3>
            </div>
            <div class="form-group">
                <label class="form-label">ì°¸ì¡°ë²ˆí˜¸ (ì¶œê³ ìš”ì²­ì„œ ë“±)</label>
                <input type="text" class="form-input" id="reference" placeholder="ì°¸ì¡°ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="form-group">
                <label class="form-label">ë¹„ê³ </label>
                <textarea class="form-input" id="remarks" rows="3" placeholder="ë¹„ê³  ì…ë ¥"></textarea>
            </div>
        </div>
        
        <!-- ì¼ê´„ ì¶œê³  ì²˜ë¦¬ ë²„íŠ¼ -->
        <button type="button" class="btn btn-warning" id="btn-process-all" style="width: 100%; padding: 16px; font-size: 1.1rem;" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <polyline points="9 14 12 17 15 14"></polyline>
            </svg>
            ì¼ê´„ ì¶œê³  ì²˜ë¦¬ (<span id="total-quantity">0</span>ê°œ)
        </button>
    </div>
    
    <!-- ìµœê·¼ ì¶œê³  ë‚´ì—­ -->
    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title">ìµœê·¼ ì¶œê³  ë‚´ì—­</h3>
        </div>
        <div id="recent-transactions">
            <div style="text-align: center; padding: 24px; color: var(--text-muted);">ë¡œë”© ì¤‘...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let scannedItems = []; // ìŠ¤ìº”ëœ í’ˆëª© ëª©ë¡ [{item: {...}, quantity: 1, barcode: '...'}, ...]
    let barcodeTimer = null;
    
    // ë°”ì½”ë“œë¡œ í’ˆëª© ê²€ìƒ‰
    async function searchItemByBarcode(barcode) {
        if (!barcode || barcode.length < 3) return null;
        
        try {
            const response = await apiRequest(`/inventory/items/?search=${encodeURIComponent(barcode)}`);
            if (response && response.ok) {
                const data = await response.json();
                const items = data.results || data;
                
                if (items.length > 0) {
                    return items[0];
                }
            }
        } catch (error) {
            console.error('Search failed:', error);
        }
        return null;
    }
    
    // ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddItemModal(barcode) {
        const modal = document.createElement('div');
        modal.id = 'add-item-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        
        modal.innerHTML = `
            <div class="card" style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <div class="card-header">
                    <h3 class="card-title">ìƒˆ í’ˆëª© ì¶”ê°€</h3>
                    <button class="btn btn-secondary btn-sm" onclick="closeAddItemModal()" style="padding: 8px 12px;">âœ•</button>
                </div>
                <form id="add-item-form">
                    <div class="form-group">
                        <label class="form-label">ê´€ë¦¬ë²ˆí˜¸(ë°”ì½”ë“œ) *</label>
                        <input type="text" class="form-input" id="add-barcode" value="${barcode}" required readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">í’ˆëª©ëª… *</label>
                        <input type="text" class="form-input" id="add-name" placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì‹œë¦¬ì–¼ë²ˆí˜¸ *</label>
                        <input type="text" class="form-input" id="add-serial" placeholder="ì‹œë¦¬ì–¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì œì‘ì‚¬</label>
                        <input type="text" class="form-input" id="add-manufacturer" placeholder="ì œì‘ì‚¬ëª…">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìˆ˜ëŸ‰</label>
                        <input type="number" class="form-input" id="add-quantity" placeholder="ìˆ˜ëŸ‰" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì ê²€ì—¬ë¶€</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="add-inspection" style="width: 20px; height: 20px;">
                                <span>ì ê²€ í•„ìš”</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì ê²€ì˜ˆì •ì¼ì</label>
                        <input type="date" class="form-input" id="add-inspection-date">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">í’ˆëª© ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddItemModal()" style="flex: 1;">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('add-name').focus();
        
        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addNewItem(barcode);
        });
    }
    
    function closeAddItemModal() {
        const modal = document.getElementById('add-item-modal');
        if (modal) {
            modal.remove();
        }
        document.getElementById('barcode-input').focus();
    }
    
    // ìƒˆ í’ˆëª© ì¶”ê°€
    async function addNewItem(barcode) {
        const name = document.getElementById('add-name').value.trim();
        const serialNumber = document.getElementById('add-serial').value.trim();
        const manufacturer = document.getElementById('add-manufacturer').value.trim();
        const quantity = parseInt(document.getElementById('add-quantity').value) || 1;
        const inspectionRequired = document.getElementById('add-inspection').checked;
        const inspectionDate = document.getElementById('add-inspection-date').value;
        
        if (!name || !serialNumber) {
            alert('í’ˆëª©ëª…ê³¼ ì‹œë¦¬ì–¼ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const response = await apiRequest('/inventory/items/', {
                method: 'POST',
                body: JSON.stringify({
                    barcode: barcode,
                    name: name,
                    serial_number: serialNumber,
                    manufacturer: manufacturer || '',
                    inspection_required: inspectionRequired,
                    inspection_due_date: inspectionDate || null
                })
            });
            
            if (response && response.ok) {
                const newItem = await response.json();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeAddItemModal();
                
                // ìƒˆë¡œ ì¶”ê°€ëœ í’ˆëª©ì„ ëª©ë¡ì— ì¶”ê°€ (ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìˆ˜ëŸ‰ìœ¼ë¡œ)
                scannedItems.push({
                    item: newItem,
                    quantity: quantity,
                    barcode: barcode,
                    scanCount: quantity
                });
                
                renderScannedItems();
                
                // ì„±ê³µ ì•Œë¦¼
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
                successMsg.textContent = `âœ“ ${name} ì¶”ê°€ë¨`;
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 2000);
            } else {
                let errorMessage = 'í’ˆëª© ì¶”ê°€ ì‹¤íŒ¨';
                try {
                    const error = await response.json();
                    if (error.barcode && Array.isArray(error.barcode)) {
                        errorMessage = error.barcode[0];
                    } else if (error.name && Array.isArray(error.name)) {
                        errorMessage = error.name[0];
                    } else if (error.serial_number && Array.isArray(error.serial_number)) {
                        errorMessage = error.serial_number[0];
                    } else if (error.detail) {
                        errorMessage = error.detail;
                    } else if (typeof error === 'string') {
                        errorMessage = error;
                    } else {
                        errorMessage = JSON.stringify(error);
                    }
                } catch (e) {
                    errorMessage = `ì„œë²„ ì˜¤ë¥˜ (${response.status})`;
                }
                
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;';
                errorMsg.textContent = `âŒ ${errorMessage}`;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 5000);
            }
        } catch (error) {
            console.error('Add item failed:', error);
            alert('í’ˆëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
    async function handleBarcodeScan(barcode) {
        const item = await searchItemByBarcode(barcode);
        
        if (!item) {
            // í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
            showAddItemModal(barcode);
            return;
        }
        
        // ì¬ê³  í™•ì¸
        if (item.current_quantity <= 0) {
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
            errorMsg.textContent = `âŒ ${item.name}ì˜ ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤`;
            document.body.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 3000);
            return;
        }
        
        // ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” í’ˆëª©ì¸ì§€ í™•ì¸
        const existingIndex = scannedItems.findIndex(si => si.item.id === item.id);
        
        if (existingIndex >= 0) {
            // ê¸°ì¡´ í’ˆëª© ìˆ˜ëŸ‰ ì¦ê°€ (ì¬ê³  í™•ì¸)
            const newQuantity = scannedItems[existingIndex].quantity + 1;
            if (newQuantity > item.current_quantity) {
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--warning); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
                errorMsg.textContent = `âš  ì¬ê³  ë¶€ì¡±: í˜„ì¬ ì¬ê³  ${item.current_quantity}ê°œ`;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
                return;
            }
            scannedItems[existingIndex].quantity = newQuantity;
            scannedItems[existingIndex].scanCount += 1;
        } else {
            // ìƒˆ í’ˆëª© ì¶”ê°€
            scannedItems.push({
                item: item,
                quantity: 1,
                barcode: barcode,
                scanCount: 1
            });
        }
        
        renderScannedItems();
        
        // ì„±ê³µ ì•Œë¦¼
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
        successMsg.textContent = `âœ“ ${item.name} ì¶”ê°€ë¨`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 1500);
    }
    
    // ìŠ¤ìº”ëœ í’ˆëª© ëª©ë¡ ë Œë”ë§
    function renderScannedItems() {
        const container = document.getElementById('scanned-items-list');
        const itemCount = scannedItems.length;
        const totalQuantity = scannedItems.reduce((sum, si) => sum + si.quantity, 0);
        
        document.getElementById('item-count').textContent = `${itemCount}ê°œ í’ˆëª©`;
        document.getElementById('total-quantity').textContent = totalQuantity;
        document.getElementById('btn-process-all').disabled = itemCount === 0;
        
        if (itemCount === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin: 0 auto 16px; opacity: 0.5;">
                        <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                        <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                        <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                        <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                        <line x1="7" y1="12" x2="17" y2="12"></line>
                    </svg>
                    <p>ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ í’ˆëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = scannedItems.map((si, index) => {
            const isOverStock = si.quantity > si.item.current_quantity;
            return `
            <div class="low-stock-item" style="margin-bottom: 12px; padding: 16px; ${isOverStock ? 'border: 2px solid var(--danger);' : ''}">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span class="badge badge-warning" style="min-width: 40px; text-align: center;">${index + 1}</span>
                        <div>
                            <div style="font-weight: 600; font-size: 1rem;">${si.item.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ${si.item.item_code}${si.item.serial_number ? ' | S/N: ' + si.item.serial_number : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 0.85rem; color: var(--text-muted); flex-wrap: wrap;">
                        <span>ìŠ¤ìº” íšŸìˆ˜: <strong style="color: var(--accent);">${si.scanCount}</strong>íšŒ</span>
                        <span>ìˆ˜ëŸ‰: <strong style="color: ${isOverStock ? 'var(--danger)' : 'var(--warning)'};">${si.quantity}</strong> ${si.item.unit}</span>
                        <span>í˜„ì¬ ì¬ê³ : <strong style="color: ${si.item.current_quantity <= 0 ? 'var(--danger)' : ''};">${si.item.current_quantity}</strong> ${si.item.unit}</span>
                        ${si.item.manufacturer ? `<span>ì œì‘ì‚¬: ${si.item.manufacturer}</span>` : ''}
                        ${si.item.inspection_required ? `<span class="badge badge-warning">ì ê²€ í•„ìš”</span>` : ''}
                    </div>
                    ${isOverStock ? '<div style="color: var(--danger); font-size: 0.8rem; margin-top: 8px;">âš  ì¬ê³  ë¶€ì¡±: ì¶œê³  ìˆ˜ëŸ‰ì´ í˜„ì¬ ì¬ê³ ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤</div>' : ''}
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-secondary btn-sm" onclick="decreaseQuantity(${index})" style="min-width: 36px; padding: 6px;">-</button>
                        <input type="number" 
                               class="form-input" 
                               value="${si.quantity}" 
                               min="1" 
                               max="${si.item.current_quantity}"
                               step="1"
                               style="width: 80px; padding: 6px 8px; text-align: center; ${isOverStock ? 'border-color: var(--danger);' : ''}"
                               onchange="updateQuantity(${index}, this.value)">
                        <button class="btn btn-secondary btn-sm" onclick="increaseQuantity(${index})" style="min-width: 36px; padding: 6px;">+</button>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeItem(${index})" style="width: 100%;">
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }
    
    function increaseQuantity(index) {
        const scannedItem = scannedItems[index];
        if (scannedItem.quantity < scannedItem.item.current_quantity) {
            scannedItem.quantity += 1;
            scannedItem.scanCount += 1;
            renderScannedItems();
        } else {
            alert(`ì¬ê³  ë¶€ì¡±: í˜„ì¬ ì¬ê³ ëŠ” ${scannedItem.item.current_quantity}ê°œì…ë‹ˆë‹¤.`);
        }
    }
    
    function decreaseQuantity(index) {
        if (scannedItems[index].quantity > 1) {
            scannedItems[index].quantity -= 1;
            scannedItems[index].scanCount -= 1;
            renderScannedItems();
        }
    }
    
    function updateQuantity(index, value) {
        const qty = parseInt(value) || 1;
        const scannedItem = scannedItems[index];
        if (qty > scannedItem.item.current_quantity) {
            alert(`ì¬ê³  ë¶€ì¡±: í˜„ì¬ ì¬ê³ ëŠ” ${scannedItem.item.current_quantity}ê°œì…ë‹ˆë‹¤.`);
            scannedItem.quantity = scannedItem.item.current_quantity;
        } else {
            scannedItem.quantity = Math.max(1, qty);
        }
        renderScannedItems();
    }
    
    function removeItem(index) {
        scannedItems.splice(index, 1);
        renderScannedItems();
    }
    
    // ë°”ì½”ë“œ ì…ë ¥ ì²˜ë¦¬
    document.getElementById('barcode-input').addEventListener('input', (e) => {
        clearTimeout(barcodeTimer);
        const barcode = e.target.value.trim();
        
        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë¹ ë¥´ê²Œ ì…ë ¥ë˜ë¯€ë¡œ, ì…ë ¥ì´ ë©ˆì¶˜ í›„ ì²˜ë¦¬
        barcodeTimer = setTimeout(async () => {
            if (barcode && barcode.length >= 3) {
                await handleBarcodeScan(barcode);
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë‹¤ìŒ ìŠ¤ìº” ì¤€ë¹„)
                e.target.value = '';
                e.target.focus();
            }
        }, 200);
    });
    
    document.getElementById('barcode-input').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(barcodeTimer);
            const barcode = e.target.value.trim();
            if (barcode) {
                await handleBarcodeScan(barcode);
                e.target.value = '';
                e.target.focus();
            }
        }
    });
    
    async function loadRecentTransactions() {
        try {
            const response = await apiRequest('/inventory/transactions/?type=out');
            if (response && response.ok) {
                const data = await response.json();
                const transactions = (data.results || data).slice(0, 5);
                
                if (transactions.length === 0) {
                    document.getElementById('recent-transactions').innerHTML = `
                        <div style="text-align: center; padding: 24px; color: var(--text-muted);">
                            ìµœê·¼ ì¶œê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('recent-transactions').innerHTML = transactions.map(t => `
                    <div class="low-stock-item">
                        <div>
                            <div style="font-weight: 600;">${t.item_name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${t.transaction_number}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--danger); font-weight: 600;">-${t.quantity}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${formatDateTime(t.created_at)}</div>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load transactions:', error);
        }
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleString('ko-KR');
    }
    
    // ì¼ê´„ ì¶œê³  ì²˜ë¦¬
    async function processAllStockOut() {
        if (scannedItems.length === 0) {
            alert('ì¶œê³ í•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ì¬ê³  í™•ì¸
        const overStockItems = scannedItems.filter(si => si.quantity > si.item.current_quantity);
        if (overStockItems.length > 0) {
            alert(`ì¬ê³  ë¶€ì¡± í’ˆëª©ì´ ìˆìŠµë‹ˆë‹¤:\n${overStockItems.map(si => `- ${si.item.name}: ìš”ì²­ ${si.quantity}ê°œ, ì¬ê³  ${si.item.current_quantity}ê°œ`).join('\n')}`);
            return;
        }
        
        const reference = document.getElementById('reference').value;
        const remarks = document.getElementById('remarks').value;
        
        // í™•ì¸ ë©”ì‹œì§€
        const totalQuantity = scannedItems.reduce((sum, si) => sum + si.quantity, 0);
        if (!confirm(`ì´ ${scannedItems.length}ê°œ í’ˆëª©, ${totalQuantity}ê°œë¥¼ ì¶œê³  ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }
        
        // ì²˜ë¦¬ ì¤‘ í‘œì‹œ
        const btn = document.getElementById('btn-process-all');
        btn.disabled = true;
        btn.innerHTML = '<span>ì²˜ë¦¬ ì¤‘...</span>';
        
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        // ê° í’ˆëª©ë³„ë¡œ ì¶œê³  ì²˜ë¦¬
        for (const scannedItem of scannedItems) {
            try {
                const response = await apiRequest('/inventory/stock/out/', {
                    method: 'POST',
                    body: JSON.stringify({
                        item_id: scannedItem.item.id,
                        quantity: scannedItem.quantity,
                        reference_number: reference,
                        remarks: `${remarks || ''} (ë°”ì½”ë“œ: ${scannedItem.barcode}, ìŠ¤ìº”íšŸìˆ˜: ${scannedItem.scanCount})`.trim()
                    })
                });
                
                if (response && response.ok) {
                    successCount++;
                } else {
                    failCount++;
                    const error = await response.json();
                    errors.push(`${scannedItem.item.name}: ${error.error || JSON.stringify(error)}`);
                }
            } catch (error) {
                failCount++;
                errors.push(`${scannedItem.item.name}: ì˜¤ë¥˜ ë°œìƒ`);
            }
        }
        
        // ê²°ê³¼ í‘œì‹œ
        if (failCount === 0) {
            // ëª¨ë‘ ì„±ê³µ
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--warning); color: white; padding: 20px 28px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;';
            successMsg.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">âœ“ ì¶œê³  ì²˜ë¦¬ ì™„ë£Œ</div>
                <div style="font-size: 0.9rem;">${successCount}ê°œ í’ˆëª©, ì´ ${totalQuantity}ê°œ ì¶œê³ ë˜ì—ˆìŠµë‹ˆë‹¤</div>
            `;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
            // í¼ ì´ˆê¸°í™”
            scannedItems = [];
            document.getElementById('reference').value = '';
            document.getElementById('remarks').value = '';
            renderScannedItems();
        } else {
            // ì¼ë¶€ ì‹¤íŒ¨
            alert(`ì²˜ë¦¬ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ\n\nì‹¤íŒ¨ í•­ëª©:\n${errors.join('\n')}`);
        }
        
        // ë²„íŠ¼ ë³µì›
        btn.disabled = false;
        btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <polyline points="9 14 12 17 15 14"></polyline>
            </svg>
            ì¼ê´„ ì¶œê³  ì²˜ë¦¬ (<span id="total-quantity">0</span>ê°œ)
        `;
        
        // ìµœì‹  ì •ë³´ ì—…ë°ì´íŠ¸
        loadRecentTransactions();
        
        // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
        setTimeout(() => {
            document.getElementById('barcode-input').focus();
        }, 100);
    }
    
    document.getElementById('btn-process-all').addEventListener('click', processAllStockOut);
    
    document.addEventListener('DOMContentLoaded', () => {
        loadRecentTransactions();
        // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì— ìë™ í¬ì»¤ìŠ¤
        setTimeout(() => {
            document.getElementById('barcode-input').focus();
        }, 100);
    });
</script>
{% endblock %}
