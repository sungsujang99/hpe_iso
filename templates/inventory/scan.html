{% extends "base.html" %}

{% block title %}ë°”ì½”ë“œ ìŠ¤ìº” - HPE System{% endblock %}
{% block nav_inventory_scan %}active{% endblock %}
{% block page_title %}ë°”ì½”ë“œ ìŠ¤ìº”{% endblock %}

{% block breadcrumb %}
<a href="/">í™ˆ</a>
<span>â€º</span>
<a href="/inventory/">ì¬ê³ ê´€ë¦¬</a>
<span>â€º</span>
<span>ë°”ì½”ë“œ ìŠ¤ìº”</span>
{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">
    <!-- Scanner Area -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ë°”ì½”ë“œ ìŠ¤ìº”</h3>
        </div>
        
        <div style="background: linear-gradient(135deg, var(--accent-light) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 16px; padding: 24px; margin-bottom: 20px; text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64" style="margin: 0 auto 16px; color: var(--accent);">
                <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                <line x1="7" y1="12" x2="17" y2="12"></line>
            </svg>
            <p style="color: var(--text); font-weight: 600; margin-bottom: 8px;">ë°”ì½”ë“œ ìŠ¤ìºë„ˆë¥¼ ì¤€ë¹„í•˜ì„¸ìš”</p>
            <p style="color: var(--text-muted); font-size: 0.9rem;">
                ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤
            </p>
        </div>
        
        <div class="form-group">
            <label class="form-label">ë°”ì½”ë“œ ì…ë ¥</label>
            <input type="text" 
                   class="form-input" 
                   id="barcode-input" 
                   placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..." 
                   autocomplete="off"
                   style="font-size: 1.1rem; padding: 16px 20px; text-align: center; letter-spacing: 2px;">
            <div style="text-align: center; margin-top: 8px;">
                <span style="color: var(--text-muted); font-size: 0.8rem;">
                    ğŸ’¡ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‚¬ìš© ì‹œ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤
                </span>
            </div>
        </div>
    </div>
    
    <!-- Scan Result -->
    <div class="card" id="result-card" style="display: none; margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title">ìŠ¤ìº” ê²°ê³¼</h3>
            <span class="badge badge-success" id="result-badge">ê²€ìƒ‰ë¨</span>
        </div>
        
        <div id="result-content">
            <!-- Content will be filled by JS -->
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <button class="btn btn-success" id="btn-stock-in" style="flex: 1;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <line x1="12" y1="17" x2="12" y2="11"></line>
                    <polyline points="9 14 12 11 15 14"></polyline>
                </svg>
                ì…ê³ 
            </button>
            <button class="btn btn-warning" id="btn-stock-out" style="flex: 1;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <polyline points="9 14 12 17 15 14"></polyline>
                </svg>
                ì¶œê³ 
            </button>
        </div>
    </div>
    
    <!-- Scan History -->
    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title">ìŠ¤ìº” ê¸°ë¡</h3>
            <button class="btn btn-secondary btn-sm" id="btn-clear-history">ê¸°ë¡ ì‚­ì œ</button>
        </div>
        <div id="scan-history">
            <div style="text-align: center; padding: 24px; color: var(--text-muted);">
                ìŠ¤ìº” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentItem = null;
    let scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    let barcodeInputTimer = null;
    let lastInputTime = 0;
    
    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ ê°ì§€ (ë¹ ë¥¸ ì—°ì† ì…ë ¥)
    function handleBarcodeInput() {
        const input = document.getElementById('barcode-input');
        const now = Date.now();
        const timeSinceLastInput = now - lastInputTime;
        lastInputTime = now;
        
        // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
        clearTimeout(barcodeInputTimer);
        
        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë³´í†µ ë§¤ìš° ë¹ ë¥´ê²Œ ì…ë ¥ë¨ (100ms ì´ë‚´)
        // ë§ˆì§€ë§‰ ì…ë ¥ í›„ 200ms ë™ì•ˆ ì¶”ê°€ ì…ë ¥ì´ ì—†ìœ¼ë©´ ê²€ìƒ‰ ì‹¤í–‰
        barcodeInputTimer = setTimeout(() => {
            const code = input.value.trim();
            if (code && code.length >= 3) { // ìµœì†Œ 3ì ì´ìƒ
                searchItem(code);
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë‹¤ìŒ ìŠ¤ìº” ì¤€ë¹„)
                setTimeout(() => {
                    input.value = '';
                    input.focus();
                }, 500);
            }
        }, 200);
    }
    
    // ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddItemModal(barcode) {
        const modal = document.createElement('div');
        modal.id = 'add-item-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        
        modal.innerHTML = `
            <div class="card" style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <div class="card-header">
                    <h3 class="card-title">ìƒˆ í’ˆëª© ì¶”ê°€</h3>
                    <button class="btn btn-secondary btn-sm" onclick="closeAddItemModal()" style="padding: 8px 12px;">âœ•</button>
                </div>
                <form id="add-item-form">
                    <div class="form-group">
                        <label class="form-label">ê´€ë¦¬ë²ˆí˜¸(ë°”ì½”ë“œ) *</label>
                        <input type="text" class="form-input" id="add-barcode" value="${barcode}" required readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">í’ˆëª©ëª… *</label>
                        <input type="text" class="form-input" id="add-name" placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì‹œë¦¬ì–¼ë²ˆí˜¸ *</label>
                        <input type="text" class="form-input" id="add-serial" placeholder="ì‹œë¦¬ì–¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì œì‘ì‚¬</label>
                        <input type="text" class="form-input" id="add-manufacturer" placeholder="ì œì‘ì‚¬ëª…">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì ê²€ì—¬ë¶€</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="add-inspection" style="width: 20px; height: 20px;">
                                <span>ì ê²€ í•„ìš”</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì ê²€ì˜ˆì •ì¼ì</label>
                        <input type="date" class="form-input" id="add-inspection-date">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">í’ˆëª© ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddItemModal()" style="flex: 1;">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('add-name').focus();
        
        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addNewItem(barcode);
        });
    }
    
    function closeAddItemModal() {
        const modal = document.getElementById('add-item-modal');
        if (modal) {
            modal.remove();
        }
        document.getElementById('barcode-input').focus();
    }
    
    // ìƒˆ í’ˆëª© ì¶”ê°€
    async function addNewItem(barcode) {
        const name = document.getElementById('add-name').value.trim();
        const serialNumber = document.getElementById('add-serial').value.trim();
        const manufacturer = document.getElementById('add-manufacturer').value.trim();
        const inspectionRequired = document.getElementById('add-inspection').checked;
        const inspectionDate = document.getElementById('add-inspection-date').value;
        
        if (!name || !serialNumber) {
            alert('í’ˆëª©ëª…ê³¼ ì‹œë¦¬ì–¼ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const response = await apiRequest('/inventory/items/', {
                method: 'POST',
                body: JSON.stringify({
                    barcode: barcode,
                    name: name,
                    serial_number: serialNumber,
                    manufacturer: manufacturer || '',
                    inspection_required: inspectionRequired,
                    inspection_due_date: inspectionDate || null
                })
            });
            
            if (response && response.ok) {
                const newItem = await response.json();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeAddItemModal();
                
                // ìƒˆë¡œ ì¶”ê°€ëœ í’ˆëª© í‘œì‹œ
                currentItem = newItem;
                showResult(newItem);
                addToHistory(barcode, newItem);
                
                // ì„±ê³µ ì•Œë¦¼
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
                successMsg.textContent = `âœ“ ${name} ì¶”ê°€ë¨`;
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 2000);
            } else {
                let errorMessage = 'í’ˆëª© ì¶”ê°€ ì‹¤íŒ¨';
                try {
                    const error = await response.json();
                    if (error.barcode && Array.isArray(error.barcode)) {
                        errorMessage = error.barcode[0];
                    } else if (error.name && Array.isArray(error.name)) {
                        errorMessage = error.name[0];
                    } else if (error.serial_number && Array.isArray(error.serial_number)) {
                        errorMessage = error.serial_number[0];
                    } else if (error.detail) {
                        errorMessage = error.detail;
                    } else if (typeof error === 'string') {
                        errorMessage = error;
                    } else {
                        errorMessage = JSON.stringify(error);
                    }
                } catch (e) {
                    errorMessage = `ì„œë²„ ì˜¤ë¥˜ (${response.status})`;
                }
                
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;';
                errorMsg.textContent = `âŒ ${errorMessage}`;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 5000);
            }
        } catch (error) {
            console.error('Add item failed:', error);
            alert('í’ˆëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    async function searchItem(code) {
        try {
            // Search by item_code or barcode
            const response = await apiRequest(`/inventory/items/?search=${encodeURIComponent(code)}`);
            if (response && response.ok) {
                const data = await response.json();
                const items = data.results || data;
                
                if (items.length > 0) {
                    currentItem = items[0];
                    showResult(currentItem);
                    addToHistory(code, currentItem);
                } else {
                    // í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
                    showAddItemModal(code);
                }
            }
        } catch (error) {
            console.error('Search failed:', error);
        }
    }
    
    function showResult(item) {
        document.getElementById('result-card').style.display = 'block';
        document.getElementById('result-badge').className = 'badge badge-success';
        document.getElementById('result-badge').textContent = 'ê²€ìƒ‰ë¨';
        
        document.getElementById('result-content').innerHTML = `
            <div style="display: grid; gap: 16px;">
                <div class="low-stock-item">
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">ê´€ë¦¬ë²ˆí˜¸(ë°”ì½”ë“œ)</div>
                        <div style="font-weight: 700; font-size: 1.2rem;">${item.barcode || item.item_code}</div>
                    </div>
                </div>
                <div class="low-stock-item">
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">í’ˆëª©ëª…</div>
                        <div style="font-weight: 600;">${item.name}</div>
                    </div>
                </div>
                ${item.serial_number ? `
                    <div class="low-stock-item">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">ì‹œë¦¬ì–¼ë²ˆí˜¸</div>
                            <div style="font-weight: 500;">${item.serial_number}</div>
                        </div>
                    </div>
                ` : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="low-stock-item">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">í˜„ì¬ ì¬ê³ </div>
                            <div style="font-weight: 600; color: ${item.is_low_stock ? 'var(--warning)' : 'var(--success)'};">
                                ${item.current_quantity} ${item.unit}
                            </div>
                        </div>
                    </div>
                    <div class="low-stock-item">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">ì•ˆì „ì¬ê³ </div>
                            <div style="font-weight: 500;">${item.safety_stock} ${item.unit}</div>
                        </div>
                    </div>
                </div>
                ${item.manufacturer ? `
                    <div class="low-stock-item">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">ì œì‘ì‚¬</div>
                            <div style="font-weight: 500;">${item.manufacturer}</div>
                        </div>
                    </div>
                ` : ''}
                ${item.inspection_required ? `
                    <div class="low-stock-item" style="border: 2px solid var(--warning);">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">ì ê²€ ì •ë³´</div>
                            <div style="font-weight: 600; color: var(--warning);">
                                ì ê²€ í•„ìš”
                                ${item.inspection_due_date ? ` (ì˜ˆì •ì¼: ${new Date(item.inspection_due_date).toLocaleDateString('ko-KR')})` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                ${item.location_name ? `
                    <div class="low-stock-item">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem;">ìœ„ì¹˜</div>
                            <div style="font-weight: 500;">${item.location_name}</div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    
    function addToHistory(code, item) {
        const entry = {
            code: code,
            name: item ? item.name : 'ë¯¸ë“±ë¡',
            time: new Date().toISOString(),
            found: !!item
        };
        scanHistory.unshift(entry);
        if (scanHistory.length > 10) scanHistory.pop();
        localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
        renderHistory();
    }
    
    function renderHistory() {
        const container = document.getElementById('scan-history');
        
        if (scanHistory.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 24px; color: var(--text-muted);">
                    ìŠ¤ìº” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }
        
        container.innerHTML = scanHistory.map(entry => `
            <div class="low-stock-item" onclick="searchItem('${entry.code}')" style="cursor: pointer;">
                <div>
                    <div style="font-weight: 600; color: ${entry.found ? 'var(--text)' : 'var(--text-muted)'}">${entry.code}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${entry.name}</div>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">
                    ${formatTime(entry.time)}
                </div>
            </div>
        `).join('');
    }
    
    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }
    
    async function stockIn() {
        if (!currentItem) return;
        
        const qty = prompt('ì…ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (!qty || isNaN(qty) || parseFloat(qty) <= 0) return;
        
        try {
            const response = await apiRequest('/inventory/stock/in/', {
                method: 'POST',
                body: JSON.stringify({
                    item_id: currentItem.id,
                    quantity: parseFloat(qty)
                })
            });
            
            if (response && response.ok) {
                alert('ì…ê³  ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                searchItem(currentItem.item_code);
            } else {
                const error = await response.json();
                alert('ì‹¤íŒ¨: ' + (error.error || JSON.stringify(error)));
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    async function stockOut() {
        if (!currentItem) return;
        
        const qty = prompt('ì¶œê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (!qty || isNaN(qty) || parseFloat(qty) <= 0) return;
        
        try {
            const response = await apiRequest('/inventory/stock/out/', {
                method: 'POST',
                body: JSON.stringify({
                    item_id: currentItem.id,
                    quantity: parseFloat(qty)
                })
            });
            
            if (response && response.ok) {
                alert('ì¶œê³  ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                searchItem(currentItem.item_code);
            } else {
                const error = await response.json();
                alert('ì‹¤íŒ¨: ' + (error.error || JSON.stringify(error)));
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
    const barcodeInput = document.getElementById('barcode-input');
    
    // ì…ë ¥ ê°ì§€ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë¹ ë¥´ê²Œ ì—°ì† ì…ë ¥)
    barcodeInput.addEventListener('input', handleBarcodeInput);
    
    // Enter í‚¤ë¡œë„ ê²€ìƒ‰ ê°€ëŠ¥
    barcodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(barcodeInputTimer);
            const code = barcodeInput.value.trim();
            if (code) {
                searchItem(code);
                setTimeout(() => {
                    barcodeInput.value = '';
                    barcodeInput.focus();
                }, 500);
            }
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í¬ì»¤ìŠ¤
    document.addEventListener('DOMContentLoaded', () => {
        renderHistory();
        // ì…ë ¥ í•„ë“œì— ìë™ í¬ì»¤ìŠ¤ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì¤€ë¹„)
        setTimeout(() => {
            barcodeInput.focus();
        }, 100);
    });
    
    // ë‹¤ë¥¸ ê³³ í´ë¦­ í›„ ë‹¤ì‹œ í¬ì»¤ìŠ¤
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#result-card') && !e.target.closest('.btn')) {
            barcodeInput.focus();
        }
    });
    
    document.getElementById('btn-stock-in').addEventListener('click', stockIn);
    document.getElementById('btn-stock-out').addEventListener('click', stockOut);
    
    document.getElementById('btn-clear-history').addEventListener('click', () => {
        if (confirm('ìŠ¤ìº” ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            scanHistory = [];
            localStorage.removeItem('scanHistory');
            renderHistory();
        }
    });
</script>
{% endblock %}
